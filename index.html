
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mini-Torneo LUI&LEI 2025</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #eee; }
    .highlight { background-color: #b3e5fc; }
    .best-third { background-color: #ffe082; }
    .filter-section { margin: 20px 0; text-align: center; }
  </style>
</head>
<body>
  <h1>Mini-Torneo di Calcio LUI&LEI 2025 - Arogno</h1>
  <div class="filter-section">
    <label for="gironeSelect">Seleziona Girone:</label>
    <select id="gironeSelect"><option value="ALL">Tutti</option></select>
  </div>
  <h2>Partite della Fase a Gironi</h2>
  <div id="programma"></div>
  <h2>Classifiche dei Gironi</h2>
  <div id="classifiche"></div>
  <h2>Classifica Migliori Terze</h2>
  <div id="miglioriTerze"></div>
  <h2>Fase Finale</h2>
  <div id="finali"></div>
  <script>
    const programmaUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=1898554956&single=true&output=csv";
    const finaliUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=660358441&single=true&output=csv";

    let gironiData = {}, miglioriTerzeGlobal = [];

    document.getElementById("gironeSelect").addEventListener("change", () => {
  const select = document.getElementById("gironeSelect");
  select.blur(); // forza l'uscita dal focus per aggiornare anche se selezioni di nuovo "Tutti"
  loadData();
});

    async function loadData() {
      const filtro = document.getElementById("gironeSelect").value;
      const programma = await fetchCSV(programmaUrl);
      const finali = await fetchCSV(finaliUrl);
      aggiornaFiltro(programma);
      mostraPartite(programma, filtro);
      mostraClassifiche(programma, filtro);
      filtro === "ALL" ? mostraTerze() : document.getElementById("miglioriTerze").innerHTML = "";
      mostraFinali(finali);
    }

    async function fetchCSV(url) {
      return new Promise((resolve, reject) => {
        Papa.parse(url, {
          download: true,
          header: true,
          complete: results => resolve(results.data.filter(r => r.DATA)),
          error: err => reject(err)
        });
      });
    }

    function aggiornaFiltro(data) {
      const select = document.getElementById("gironeSelect");
      const gironi = [...new Set(data.map(p => p.GIRONE))].sort();
      select.innerHTML = '<option value="ALL">Tutti</option>' + gironi.map(g => `<option value="${g}">Girone ${g}</option>`).join('');
    }

    function mostraPartite(data, filtro) {
      const container = document.getElementById("programma");
      const partite = filtro === "ALL" ? data : data.filter(p => p.GIRONE === filtro);
      partite.sort((a,b) => new Date(`${a.DATA} ${a.ORA}`) - new Date(`${b.DATA} ${b.ORA}`));
      container.innerHTML = "<table><thead><tr><th>Data</th><th>Ora</th><th>Campo</th><th>Girone</th><th>Squadra 1</th><th>Squadra 2</th><th>Risultato</th></tr></thead><tbody>" +
        partite.map(p => `<tr><td>${p.DATA}</td><td>${p.ORA}</td><td>${p.CAMPO}</td><td>${p.GIRONE}</td><td>${p.SQUADRA1}</td><td>${p.SQUADRA2}</td><td>${p.RISULTATO}</td></tr>`).join('') +
        "</tbody></table>";
    }

    function mostraClassifiche(data, filtro) {
      const div = document.getElementById("classifiche");
      div.innerHTML = "";
      const gironi = filtro === "ALL" ? [...new Set(data.map(p => p.GIRONE))] : [filtro];
      gironiData = {};

      for (const g of gironi) {
        const partite = data.filter(p => p.GIRONE === g && p.RISULTATO);
        const cls = {};
        for (const p of partite) {
          const [g1, g2] = p.RISULTATO.split("-").map(Number);
          [p.SQUADRA1, p.SQUADRA2].forEach(sq => cls[sq] = cls[sq] || { giocate: 0, punti: 0, gf: 0, gs: 0 });
          cls[p.SQUADRA1].giocate++; cls[p.SQUADRA2].giocate++;
          cls[p.SQUADRA1].gf += g1; cls[p.SQUADRA1].gs += g2;
          cls[p.SQUADRA2].gf += g2; cls[p.SQUADRA2].gs += g1;
          if (g1 > g2) cls[p.SQUADRA1].punti += 3;
          else if (g1 < g2) cls[p.SQUADRA2].punti += 3;
          else { cls[p.SQUADRA1].punti += 1; cls[p.SQUADRA2].punti += 1; }
        }
        const arr = Object.entries(cls).map(([squadra, stats]) => ({ squadra, ...stats }));
        arr.sort((a,b) => b.punti - a.punti || (b.gf-b.gs)-(a.gf-a.gs) || b.gf - a.gf);
        gironiData[g] = arr;
      }

      const terze = Object.values(gironiData).map(g => g[2]).filter(Boolean);
      terze.sort((a,b) => b.punti - a.punti || (b.gf-b.gs)-(a.gf-a.gs) || b.gf - a.gf);
      miglioriTerzeGlobal = terze;
      let topTwo = [];
      if (miglioriTerzeGlobal.length >= 2) {
        topTwo = miglioriTerzeGlobal.slice(0, 2).map(t => t.squadra);
      }

      for (const g of gironi) {
        const arr = gironiData[g];
        const rows = arr.map((t, i) => {
          const dr = t.gf - t.gs;
          let cls = "";
          if (i < 2) cls = "highlight";
          if (topTwo.includes(t.squadra)) cls = "best-third";
          return `<tr class="${cls}"><td>${t.squadra}</td><td>${t.giocate}</td><td>${t.punti}</td><td>${t.gf}</td><td>${t.gs}</td><td>${dr}</td></tr>`;
        }).join('');
        div.innerHTML += `<h3>Girone ${g}</h3><table><thead><tr><th>Squadra</th><th>Giocate</th><th>Punti</th><th>GF</th><th>GS</th><th>DR</th></tr></thead><tbody>${rows}</tbody></table>`;
      }
    }

    function mostraTerze() {
      const div = document.getElementById("miglioriTerze");
      if (!miglioriTerzeGlobal.length) return;
      const topTwo = miglioriTerzeGlobal.slice(0,2).map(t => t.squadra);
      const rows = miglioriTerzeGlobal.map((t,i) => {
        const dr = t.gf - t.gs;
        const cls = topTwo.includes(t.squadra) ? "best-third" : "";
        return `<tr class="${cls}"><td>${t.squadra}</td><td>${t.punti}</td><td>${t.gf}</td><td>${t.gs}</td><td>${dr}</td></tr>`;
      }).join('');
      div.innerHTML = `<table><thead><tr><th>Squadra</th><th>Punti</th><th>GF</th><th>GS</th><th>DR</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    function mostraFinali(data) {
      const container = document.getElementById("finali");
      data.sort((a,b) => new Date(`${a.DATA} ${a.ORA}`) - new Date(`${b.DATA} ${b.ORA}`));
      container.innerHTML = "<table><thead><tr><th>Data</th><th>Ora</th><th>Campo</th><th>Turno</th><th>Squadra 1</th><th>Squadra 2</th><th>Risultato</th></tr></thead><tbody>" +
        data.map(p => `<tr><td>${p.DATA}</td><td>${p.ORA}</td><td>${p.CAMPO}</td><td>${p.TURNO}</td><td>${p.SQUADRA1}</td><td>${p.SQUADRA2}</td><td>${p.RISULTATO}</td></tr>`).join('') +
        "</tbody></table>";
    }

    loadData();
  </script>
</body>
</html>
