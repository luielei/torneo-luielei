<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Programma LUI&LEI</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      padding: 20px;
    }
    h2 {
      margin-top: 40px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    th {
      background-color: #eee;
    }
    .highlight {
      background-color: lightgreen;
    }
    .filter-container {
      margin-bottom: 10px;
    }
    .terze {
      margin-top: 30px;
    }
  </style>
</head>
<body>

  <h1>Programma Torneo LUI&LEI</h1>

  <div class="filter-container">
    <label for="filter-giorno">Filtra per giorno:</label>
    <select id="filter-giorno">
      <option value="">Tutti</option>
    </select>
    <label for="filter-campo">Filtra per campo:</label>
    <select id="filter-campo">
      <option value="">Tutti</option>
    </select>
    <label for="filter-girone">Filtra per girone:</label>
    <select id="filter-girone">
      <option value="">Tutti</option>
    </select>
  </div>

  <h2>Partite</h2>
  <table id="programma-table">
    <thead>
      <tr>
        <th>Giorno</th><th>Data</th><th>Ora</th><th>Campo</th><th>Girone</th><th>Squadra 1</th><th>Squadra 2</th><th>Risultato</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="classifiche-container"></div>
  <div id="terze-container" class="terze"></div>

  <script>
    const programmaCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=1898554956&single=true&output=csv&cachebuster=" + new Date().getTime();

    let partite = [];
    let gironi = {};
    let classificaTerze = [];

    function parseRisultato(ris) {
      const [g1, g2] = ris.split("-").map(n => parseInt(n));
      return [isNaN(g1) ? 0 : g1, isNaN(g2) ? 0 : g2];
    }

    function aggiornaClassifica(girone, squadra, gf, gs) {
      if (!gironi[girone][squadra]) gironi[girone][squadra] = { punti: 0, gf: 0, gs: 0, giocate: 0, vinte: 0, pari: 0, perse: 0 };
      let team = gironi[girone][squadra];
      team.gf += gf;
      team.gs += gs;
      team.giocate++;
      if (gf > gs) {
        team.punti += 3;
        team.vinte++;
      } else if (gf === gs) {
        team.punti += 1;
        team.pari++;
      } else {
        team.perse++;
      }
    }

    function isFinale(riga) {
      return riga.TURNO && riga.TURNO.toLowerCase().includes("finale");
    }

    function getClassificaOrdinata(g) {
      return Object.entries(gironi[g]).map(([squadra, stats]) => ({
        squadra, ...stats, dr: stats.gf - stats.gs
      })).sort((a, b) =>
        b.punti - a.punti || (b.gf - b.gs) - (a.gf - a.gs) || b.gf - a.gf
      );
    }

    function render() {
      const tbody = document.querySelector("#programma-table tbody");
      tbody.innerHTML = "";

      const giornoSel = document.getElementById("filter-giorno").value;
      const campoSel = document.getElementById("filter-campo").value;
      const gironeSel = document.getElementById("filter-girone").value;

      partite.forEach(p => {
        if ((giornoSel && p.GIORNO !== giornoSel) ||
            (campoSel && p.CAMPO !== campoSel) ||
            (gironeSel && p.GIRONE !== gironeSel)) return;

        const tr = document.createElement("tr");
        [p.GIORNO, p.DATA, p.ORA, p.CAMPO, p.GIRONE, p.SQUADRA1, p.SQUADRA2, p.RISULTATO].forEach(t => {
          const td = document.createElement("td");
          td.textContent = t;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      renderClassifiche();
    }

    function renderClassifiche() {
      const container = document.getElementById("classifiche-container");
      container.innerHTML = "<h2>Classifiche</h2>";
      classificaTerze = [];

      Object.keys(gironi).sort().forEach(g => {
        let classifica = getClassificaOrdinata(g);
        const table = document.createElement("table");
        const caption = document.createElement("caption");
        caption.textContent = `Girone ${g}`;
        table.appendChild(caption);
        table.innerHTML += `
          <thead><tr><th>Squadra</th><th>Pt</th><th>G</th><th>V</th><th>P</th><th>S</th><th>GF</th><th>GS</th><th>DR</th></tr></thead>
        `;
        const tbody = document.createElement("tbody");

        classifica.forEach((team, i) => {
          const tr = document.createElement("tr");
          if (i === 0 || i === 1) tr.classList.add("highlight");
          if (i === 2) classificaTerze.push({ ...team, girone: g });
          tr.innerHTML = `<td>${team.squadra}</td><td>${team.punti}</td><td>${team.giocate}</td><td>${team.vinte}</td><td>${team.pari}</td><td>${team.perse}</td><td>${team.gf}</td><td>${team.gs}</td><td>${team.dr}</td>`;
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        if (!document.getElementById("filter-girone").value || document.getElementById("filter-girone").value === g)
          container.appendChild(table);
      });

      renderTerze();
    }

    function renderTerze() {
      const div = document.getElementById("terze-container");
      if (document.getElementById("filter-girone").value) {
        div.innerHTML = "";
        return;
      }

      const topTerze = classificaTerze
        .sort((a, b) =>
          b.punti - a.punti || b.dr - a.dr || b.gf - a.gf
        );

      const table = document.createElement("table");
      table.innerHTML = "<caption>Classifica terze classificate</caption><thead><tr><th>Girone</th><th>Squadra</th><th>Pt</th><th>DR</th></tr></thead>";
      const tbody = document.createElement("tbody");
      topTerze.forEach((team, i) => {
        const tr = document.createElement("tr");
        if (i < 2) tr.classList.add("highlight");
        tr.innerHTML = `<td>${team.girone}</td><td>${team.squadra}</td><td>${team.punti}</td><td>${team.dr}</td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      div.innerHTML = "";
      div.appendChild(table);
    }

    async function init() {
      const res = await fetch(programmaCSV);
      const csv = await res.text();
      const righe = csv.split("\n").slice(1).filter(r => r.trim());
      const intestazioni = ["GIORNO", "DATA", "ORA", "CAMPO", "GIRONE", "IDSQUADRA1", "IDSQUADRA2", "SQUADRA1", "SQUADRA2", "RISULTATO", "TURNO"];
      gironi = {};
      partite = [];

      righe.forEach(r => {
        const v = r.split(",");
        const riga = {};
        intestazioni.forEach((k, i) => riga[k] = (v[i] || "").trim());
        partite.push(riga);

        const { GIRONE, SQUADRA1, SQUADRA2, RISULTATO } = riga;
        if (GIRONE && !isFinale(riga)) {
          if (!gironi[GIRONE]) gironi[GIRONE] = {};
          const [g1, g2] = parseRisultato(RISULTATO);
          aggiornaClassifica(GIRONE, SQUADRA1, g1, g2);
          aggiornaClassifica(GIRONE, SQUADRA2, g2, g1);
        }
      });

      const giorni = [...new Set(partite.map(p => p.GIORNO))].filter(Boolean).sort();
      const campi = [...new Set(partite.map(p => p.CAMPO))].filter(Boolean).sort();
      const gironiUnici = [...new Set(partite.map(p => p.GIRONE))].filter(g => g.length === 1).sort();

      giorni.forEach(g => {
        const opt = document.createElement("option");
        opt.value = g;
        opt.textContent = g;
        document.getElementById("filter-giorno").appendChild(opt);
      });
      campi.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        document.getElementById("filter-campo").appendChild(opt);
      });
      gironiUnici.forEach(g => {
        const opt = document.createElement("option");
        opt.value = g;
        opt.textContent = g;
        document.getElementById("filter-girone").appendChild(opt);
      });

      document.querySelectorAll("select").forEach(s => s.addEventListener("change", render));

      render();
    }

    init();
  </script>
</body>
</html>
