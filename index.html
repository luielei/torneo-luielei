<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Programma LUI&LEI</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    select {
      margin-right: 10px;
      padding: 5px;
    }
  </style>
</head>
<body>
  <h1>Programma LUI&amp;LEI</h1>
  <div>
    <label for="giornoFilter">Giorno:</label>
    <select id="giornoFilter"></select>

    <label for="campoFilter">Campo:</label>
    <select id="campoFilter"></select>

    <label for="gironeFilter">Girone:</label>
    <select id="gironeFilter"></select>
  </div>

  <h2>Partite</h2>
  <table id="programmaTable">
    <thead>
      <tr>
        <th>Giorno</th>
        <th>Data</th>
        <th>Ora</th>
        <th>Campo</th>
        <th>Girone</th>
        <th>Squadra 1</th>
        <th>Risultato</th>
        <th>Squadra 2</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Classifiche</h2>
  <div id="classifiche"></div>

  <script>
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=1898554956&single=true&output=csv';
    let data = [];

    function createSelectOptions(selectId, values) {
      const select = document.getElementById(selectId);
      select.innerHTML = '<option value="">Tutti</option>' + [...new Set(values)].map(v => `<option value="${v}">${v}</option>`).join('');
      select.addEventListener('change', render);
    }

    function render() {
      const giorno = document.getElementById('giornoFilter').value;
      const campo = document.getElementById('campoFilter').value;
      const girone = document.getElementById('gironeFilter').value;

      const filtered = data.filter(row =>
        (!giorno || row.GIORNO === giorno) &&
        (!campo || row.CAMPO === campo) &&
        (!girone || row.GIRONE === girone)
      );

      const tbody = document.querySelector('#programmaTable tbody');
      tbody.innerHTML = '';
      filtered.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.GIORNO}</td><td>${row.DATA}</td><td>${row.ORA}</td><td>${row.CAMPO}</td><td>${row.GIRONE}</td><td>${row.SQUADRA1}</td><td>${row.RISULTATO}</td><td>${row.SQUADRA2}</td>`;
        tbody.appendChild(tr);
      });

      renderClassifiche(filtered, girone);
    }

    function renderClassifiche(partite, gironeFiltro) {
      const classifiche = {};

      partite.forEach(p => {
        const [g1, g2] = p.RISULTATO.split('-').map(Number);
        if (isNaN(g1) || isNaN(g2)) return;

        [
          [p.SQUADRA1, g1, g2],
          [p.SQUADRA2, g2, g1]
        ].forEach(([team, gf, gs], i) => {
          if (!classifiche[p.GIRONE]) classifiche[p.GIRONE] = {};
          if (!classifiche[p.GIRONE][team]) classifiche[p.GIRONE][team] = {
            punti: 0, gf: 0, gs: 0, pg: 0, v: 0, p: 0, s: 0
          };
          const stat = classifiche[p.GIRONE][team];
          stat.pg++;
          stat.gf += gf;
          stat.gs += gs;
          if (gf > gs) { stat.punti += 3; stat.v++; }
          else if (gf === gs) { stat.punti += 1; stat.p++; }
          else { stat.s++; }
        });
      });

      const container = document.getElementById('classifiche');
      container.innerHTML = '';
      Object.entries(classifiche).forEach(([girone, squadre]) => {
        if (gironeFiltro && gironeFiltro !== girone) return;

        const title = document.createElement('h3');
        title.textContent = `Girone ${girone}`;
        const table = document.createElement('table');
        table.innerHTML = `
          <thead>
            <tr>
              <th>Squadra</th><th>PG</th><th>V</th><th>P</th><th>S</th><th>GF</th><th>GS</th><th>Diff</th><th>Punti</th>
            </tr>
          </thead>
          <tbody>
            ${Object.entries(squadre).sort((a,b) => b[1].punti - a[1].punti || (b[1].gf-b[1].gs) - (a[1].gf-a[1].gs)).map(([nome, stat]) =>
              `<tr><td>${nome}</td><td>${stat.pg}</td><td>${stat.v}</td><td>${stat.p}</td><td>${stat.s}</td><td>${stat.gf}</td><td>${stat.gs}</td><td>${stat.gf - stat.gs}</td><td>${stat.punti}</td></tr>`
            ).join('')}
          </tbody>
        `;
        container.appendChild(title);
        container.appendChild(table);
      });
    }

    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      complete: function(results) {
        data = results.data.filter(row => row.SQUADRA1 && row.SQUADRA2);
        createSelectOptions('giornoFilter', data.map(r => r.GIORNO));
        createSelectOptions('campoFilter', data.map(r => r.CAMPO));
        createSelectOptions('gironeFilter', data.map(r => r.GIRONE));
        render();
      }
    });
  </script>
  function loadCSV(url) {
  Papa.parse(url, {
    download: true,
    header: true,
    complete: function(results) {
      const data = results.data;

      const matches = data.map(row => ({
        giorno: row.GIORNO,
        data: row.DATA,
        ora: row.ORA,
        campo: row.CAMPO,
        girone: row.GIRONE,
        squadra1: row.SQUADRA1,
        squadra2: row.SQUADRA2,
        risultato: row.RISULTATO
      }));

      // ðŸ”½ ORDINA LE PARTITE PER DATA E ORA
      matches.sort((a, b) => {
        const dateA = new Date(`${a.data} ${a.ora}`);
        const dateB = new Date(`${b.data} ${b.ora}`);
        return dateA - dateB;
      });

      renderMatches(matches);
      renderFilters(matches);
      renderStandings(matches);
    }
  });
}

</body>
</html>