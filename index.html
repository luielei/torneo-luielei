<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Torneo LUI&LEI - Programma e Classifiche</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    select {
      margin: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body>
  <h1>Programma Partite</h1>
  <label for="campoFilter">Campo:</label>
  <select id="campoFilter"></select>

  <label for="gironeFilter">Girone:</label>
  <select id="gironeFilter"></select>

  <label for="giornoFilter">Giorno:</label>
  <select id="giornoFilter"></select>

  <table id="matchTable">
    <thead>
      <tr>
        <th>Giorno</th>
        <th>Data</th>
        <th>Ora</th>
        <th>Campo</th>
        <th>Girone</th>
        <th>Squadra 1</th>
        <th>Risultato</th>
        <th>Squadra 2</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Classifiche</h2>
  <div id="standingsContainer"></div>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=1898554956&single=true&output=csv";

    function loadCSV(url) {
      Papa.parse(url, {
        download: true,
        header: true,
        complete: function(results) {
          const data = results.data;

          const matches = data.map(row => ({
            giorno: row.GIORNO,
            data: row.DATA,
            ora: row.ORA,
            campo: row.CAMPO,
            girone: row.GIRONE,
            squadra1: row.SQUADRA1,
            squadra2: row.SQUADRA2,
            risultato: row.RISULTATO
          }));

          matches.sort((a, b) => {
            const dateA = new Date(`${a.data} ${a.ora}`);
            const dateB = new Date(`${b.data} ${b.ora}`);
            return dateA - dateB;
          });

          renderMatches(matches);
          renderFilters(matches);
          renderStandings(matches);
        }
      });
    }

    function renderMatches(matches) {
      const tbody = document.querySelector("#matchTable tbody");
      tbody.innerHTML = "";

      const campo = document.getElementById("campoFilter").value;
      const girone = document.getElementById("gironeFilter").value;
      const giorno = document.getElementById("giornoFilter").value;

      matches.forEach(match => {
        if ((campo === "" || match.campo === campo) &&
            (girone === "" || match.girone === girone) &&
            (giorno === "" || match.giorno === giorno)) {

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${match.giorno}</td>
            <td>${match.data}</td>
            <td>${match.ora}</td>
            <td>${match.campo}</td>
            <td>${match.girone}</td>
            <td>${match.squadra1}</td>
            <td>${match.risultato}</td>
            <td>${match.squadra2}</td>
          `;
          tbody.appendChild(row);
        }
      });
    }

    function renderFilters(matches) {
      const campoFilter = document.getElementById("campoFilter");
      const gironeFilter = document.getElementById("gironeFilter");
      const giornoFilter = document.getElementById("giornoFilter");

      const campi = [...new Set(matches.map(m => m.campo))];
      const gironi = [...new Set(matches.map(m => m.girone))];
      const giorni = [...new Set(matches.map(m => m.giorno))];

      campoFilter.innerHTML = `<option value="">Tutti</option>` + campi.map(c => `<option value="${c}">${c}</option>`).join("");
      gironeFilter.innerHTML = `<option value="">Tutti</option>` + gironi.map(g => `<option value="${g}">${g}</option>`).join("");
      giornoFilter.innerHTML = `<option value="">Tutti</option>` + giorni.map(g => `<option value="${g}">${g}</option>`).join("");

      campoFilter.onchange = () => renderMatches(matches);
      gironeFilter.onchange = () => {
        renderMatches(matches);
        renderStandings(matches);
      };
      giornoFilter.onchange = () => renderMatches(matches);
    }

    function renderStandings(matches) {
      const gironeFilter = document.getElementById("gironeFilter").value;
      const standingsContainer = document.getElementById("standingsContainer");
      standingsContainer.innerHTML = "";

      const grouped = {};
      matches.forEach(match => {
        if (!match.risultato.includes("-")) return;
        const [gol1, gol2] = match.risultato.split("-").map(Number);
        const girone = match.girone;

        if (gironeFilter !== "" && girone !== gironeFilter) return;

        if (!grouped[girone]) grouped[girone] = {};

        [match.squadra1, match.squadra2].forEach(sq => {
          if (!grouped[girone][sq]) grouped[girone][sq] = { PG: 0, V: 0, N: 0, P: 0, GF: 0, GS: 0, Punti: 0 };
        });

        grouped[girone][match.squadra1].PG++;
        grouped[girone][match.squadra2].PG++;
        grouped[girone][match.squadra1].GF += gol1;
        grouped[girone][match.squadra1].GS += gol2;
        grouped[girone][match.squadra2].GF += gol2;
        grouped[girone][match.squadra2].GS += gol1;

        if (gol1 > gol2) {
          grouped[girone][match.squadra1].V++;
          grouped[girone][match.squadra1].Punti += 3;
          grouped[girone][match.squadra2].P++;
        } else if (gol1 < gol2) {
          grouped[girone][match.squadra2].V++;
          grouped[girone][match.squadra2].Punti += 3;
          grouped[girone][match.squadra1].P++;
        } else {
          grouped[girone][match.squadra1].N++;
          grouped[girone][match.squadra2].N++;
          grouped[girone][match.squadra1].Punti += 1;
          grouped[girone][match.squadra2].Punti += 1;
        }
      });

      Object.entries(grouped).forEach(([girone, squadre]) => {
        const table = document.createElement("table");
        const caption = document.createElement("caption");
        caption.textContent = `Girone ${girone}`;
        table.appendChild(caption);

        const header = document.createElement("tr");
        ["Squadra", "PG", "V", "N", "P", "GF", "GS", "Punti"].forEach(h => {
          const th = document.createElement("th");
          th.textContent = h;
          header.appendChild(th);
        });
        table.appendChild(header);

        const sorted = Object.entries(squadre).sort(([, a], [, b]) => b.Punti - a.Punti || (b.GF - b.GS) - (a.GF - a.GS));
        sorted.forEach(([nome, stats]) => {
          const row = document.createElement("tr");
          row.innerHTML = `<td>${nome}</td><td>${stats.PG}</td><td>${stats.V}</td><td>${stats.N}</td><td>${stats.P}</td><td>${stats.GF}</td><td>${stats.GS}</td><td>${stats.Punti}</td>`;
          table.appendChild(row);
        });

        standingsContainer.appendChild(table);
      });
    }

    loadCSV(csvUrl);
  </script>
</body>
</html>
