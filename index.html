<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LUI&LEI - Programma Torneo</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Orbitron', sans-serif;
      background-color: #f4f4f4;
      color: #1f2937;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 2rem;
    }
    th, td {
      padding: 0.75rem;
      border-bottom: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #1f2937;
      color: white;
      text-transform: uppercase;
    }
    tr:nth-child(even) {
      background-color: #e5e7eb;
    }
    .filter-select {
      margin: 0.5rem;
      padding: 0.5rem;
      border-radius: 0.5rem;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body class="p-4">
  <h1 class="text-4xl text-center mb-6 text-blue-800">Torneo LUI&LEI 2025</h1>
  <div class="flex flex-wrap justify-center mb-4 gap-4">
    <select id="filtroGiorno" class="filter-select"></select>
    <select id="filtroCampo" class="filter-select"></select>
    <select id="filtroGirone" class="filter-select"></select>
  </div>

  <h2 class="text-2xl text-center mb-2">Programma Partite</h2>
  <div class="overflow-x-auto">
    <table id="tabellaProgramma" class="bg-white shadow-md rounded-lg"></table>
  </div>

  <h2 class="text-2xl text-center mt-8 mb-2">Classifiche</h2>
  <div class="overflow-x-auto">
    <table id="tabellaClassifiche" class="bg-white shadow-md rounded-lg"></table>
  </div>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=1898554956&single=true&output=csv";

    let dati = [];
    let gironi = new Set();
    let campi = new Set();
    let giorni = new Set();

    function aggiornaFiltri() {
      ["filtroGiorno", "filtroCampo", "filtroGirone"].forEach(id => {
        const select = document.getElementById(id);
        select.innerHTML = '<option value="">Tutti</option>';
      });

      [...giorni].sort().forEach(g => filtroGiorno.innerHTML += `<option value="${g}">${g}</option>`);
      [...campi].sort().forEach(c => filtroCampo.innerHTML += `<option value="${c}">${c}</option>`);
      [...gironi].sort().forEach(g => filtroGirone.innerHTML += `<option value="${g}">${g}</option>`);
    }

    function filtraDati() {
      const giorno = filtroGiorno.value;
      const campo = filtroCampo.value;
      const girone = filtroGirone.value;

      return dati.filter(row => {
        return (!giorno || row.GIORNO === giorno) &&
               (!campo || row.CAMPO === campo) &&
               (!girone || row.GIRONE === girone);
      }).sort((a, b) => new Date(`${a.DATA} ${a.ORA}`) - new Date(`${b.DATA} ${b.ORA}`));
    }

    function mostraProgramma() {
      const data = filtraDati();
      const tab = document.getElementById("tabellaProgramma");
      tab.innerHTML = `
        <thead>
          <tr>
            <th>Giorno</th><th>Data</th><th>Ora</th><th>Campo</th><th>Girone</th>
            <th>Squadra 1</th><th>Risultato</th><th>Squadra 2</th>
          </tr>
        </thead>
        <tbody>
          ${data.map(r => `
            <tr>
              <td>${r.GIORNO}</td>
              <td>${r.DATA}</td>
              <td>${r.ORA}</td>
              <td>${r.CAMPO}</td>
              <td>${r.GIRONE}</td>
              <td>${r.SQUADRA1}</td>
              <td>${r.RISULTATO}</td>
              <td>${r.SQUADRA2}</td>
            </tr>`).join("")}
        </tbody>`;
    }

    function mostraClassifiche() {
      const girone = filtroGirone.value;
      const matches = filtraDati();
      const classifica = {};

      matches.forEach(row => {
        if (!row.RISULTATO.includes("-")) return;
        const [gol1, gol2] = row.RISULTATO.split("-").map(Number);
        const s1 = row.SQUADRA1;
        const s2 = row.SQUADRA2;
        const g = row.GIRONE;

        if (!classifica[g]) classifica[g] = {};
        [s1, s2].forEach(s => {
          if (!classifica[g][s]) classifica[g][s] = { PG: 0, V: 0, N: 0, P: 0, GF: 0, GS: 0, Punti: 0 };
        });

        classifica[g][s1].PG++;
        classifica[g][s2].PG++;
        classifica[g][s1].GF += gol1;
        classifica[g][s1].GS += gol2;
        classifica[g][s2].GF += gol2;
        classifica[g][s2].GS += gol1;

        if (gol1 > gol2) {
          classifica[g][s1].V++;
          classifica[g][s1].Punti += 3;
          classifica[g][s2].P++;
        } else if (gol1 < gol2) {
          classifica[g][s2].V++;
          classifica[g][s2].Punti += 3;
          classifica[g][s1].P++;
        } else {
          classifica[g][s1].N++;
          classifica[g][s2].N++;
          classifica[g][s1].Punti++;
          classifica[g][s2].Punti++;
        }
      });

      const tab = document.getElementById("tabellaClassifiche");
      tab.innerHTML = "";

      Object.keys(classifica).sort().forEach(g => {
        if (girone && girone !== g) return;
        const squadre = Object.entries(classifica[g])
          .sort((a, b) => b[1].Punti - a[1].Punti || b[1].GF - a[1].GF);

        tab.innerHTML += `
          <thead><tr><th colspan="9">Girone ${g}</th></tr>
          <tr>
            <th>Squadra</th><th>PG</th><th>V</th><th>N</th><th>P</th><th>GF</th><th>GS</th><th>DR</th><th>Punti</th>
          </tr></thead>
          <tbody>
          ${squadre.map(([sq, s]) => `
            <tr>
              <td>${sq}</td><td>${s.PG}</td><td>${s.V}</td><td>${s.N}</td><td>${s.P}</td>
              <td>${s.GF}</td><td>${s.GS}</td><td>${s.GF - s.GS}</td><td>${s.Punti}</td>
            </tr>`).join("")}
          </tbody>`;
      });
    }

    function aggiorna() {
      mostraProgramma();
      mostraClassifiche();
    }

    Papa.parse(csvUrl, {
      download: true,
      header: true,
      complete: function(res) {
        dati = res.data.filter(row => row.SQUADRA1 && row.SQUADRA2);
        dati.forEach(r => {
          giorni.add(r.GIORNO);
          campi.add(r.CAMPO);
          gironi.add(r.GIRONE);
        });
        aggiornaFiltri();
        aggiorna();
      }
    });

    ["filtroGiorno", "filtroCampo", "filtroGirone"].forEach(id => {
      document.getElementById(id).addEventListener("change", aggiorna);
    });
  </script>
</body>
</html>
