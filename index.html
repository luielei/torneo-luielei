<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Programma Torneo LUI&LEI</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 20px; }
    h2 { color: #222; margin-top: 40px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { padding: 8px 12px; border: 1px solid #ccc; text-align: center; }
    th { background: #eee; }
    .highlight { background-color: #d4edda; font-weight: bold; }
    .top-two { background-color: #cce5ff; font-weight: bold; }
    select { padding: 5px; margin: 0 10px 20px 0; }
  </style>
</head>
<body>

  <h1>Programma Torneo LUI&LEI</h1>

  <div>
    <label for="campoFilter">Campo:</label>
    <select id="campoFilter">
      <option value="">Tutti</option>
    </select>

    <label for="giornoFilter">Giorno:</label>
    <select id="giornoFilter">
      <option value="">Tutti</option>
    </select>

    <label for="gironeFilter">Girone:</label>
    <select id="gironeFilter">
      <option value="">Tutti</option>
    </select>
  </div>

  <h2>Partite - Fase a gironi</h2>
  <div id="programma"></div>

  <h2>Classifiche</h2>
  <div id="classifiche"></div>

  <h2>Classifica migliori terze classificate</h2>
  <div id="miglioriTerze"></div>

  <h2>Fase finale</h2>
  <div id="faseFinale"></div>

  <script>
    const gironiUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=1898554956&single=true&output=csv&cachebuster=" + Date.now();
    const finaliUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=660358441&single=true&output=csv&cachebuster=" + Date.now();

    let partite = [];
    let classifiche = {};

    function parseRisultato(ris) {
      const [g1, g2] = ris.split("-").map(Number);
      return { g1, g2 };
    }

    function aggiornaClassifica(cl, squadra, golFatti, golSubiti, punti) {
      if (!cl[squadra]) cl[squadra] = { PG: 0, V: 0, N: 0, P: 0, GF: 0, GS: 0, PT: 0 };
      cl[squadra].PG++;
      cl[squadra].GF += golFatti;
      cl[squadra].GS += golSubiti;
      cl[squadra].PT += punti;
      if (punti === 3) cl[squadra].V++;
      else if (punti === 1) cl[squadra].N++;
      else cl[squadra].P++;
    }

    function renderClassifiche() {
      const container = document.getElementById("classifiche");
      container.innerHTML = "";
      const gironeFilter = document.getElementById("gironeFilter").value;

      const miglioriTerze = [];

      Object.keys(classifiche).sort().forEach(girone => {
        const squadre = Object.entries(classifiche[girone]);
        if (squadre.length === 0) return;

        squadre.sort((a, b) => {
          const diffA = a[1].GF - a[1].GS;
          const diffB = b[1].GF - b[1].GS;
          if (b[1].PT !== a[1].PT) return b[1].PT - a[1].PT;
          if (diffB !== diffA) return diffB - diffA;
          return b[1].GF - a[1].GF;
        });

        if (gironeFilter && girone !== gironeFilter) return;

        const table = document.createElement("table");
        const thead = `<thead><tr><th>Squadra (${girone})</th><th>PG</th><th>V</th><th>N</th><th>P</th><th>GF</th><th>GS</th><th>DR</th><th>PT</th></tr></thead>`;
        let tbody = "<tbody>";

        squadre.forEach((s, i) => {
          const c = s[1];
          const dr = c.GF - c.GS;
          let cls = "";
          if (i === 0 || i === 1) cls = "top-two";
          if (i === 2) miglioriTerze.push({ girone, squadra: s[0], ...c });
          tbody += `<tr class="${cls}"><td>${s[0]}</td><td>${c.PG}</td><td>${c.V}</td><td>${c.N}</td><td>${c.P}</td><td>${c.GF}</td><td>${c.GS}</td><td>${dr}</td><td>${c.PT}</td></tr>`;
        });
        tbody += "</tbody>";
        table.innerHTML = thead + tbody;
        container.appendChild(table);
      });

      if (!gironeFilter) {
        miglioriTerze.sort((a, b) => {
          const drA = a.GF - a.GS;
          const drB = b.GF - b.GS;
          if (b.PT !== a.PT) return b.PT - a.PT;
          if (drB !== drA) return drB - drA;
          return b.GF - a.GF;
        });

        const miglioriDiv = document.getElementById("miglioriTerze");
        const table = document.createElement("table");
        let tbody = "<thead><tr><th>Squadra</th><th>Girone</th><th>PT</th><th>GF</th><th>GS</th><th>DR</th></tr></thead><tbody>";
        miglioriTerze.forEach((t, i) => {
          const dr = t.GF - t.GS;
          const cls = i < 2 ? "highlight" : "";
          tbody += `<tr class="${cls}"><td>${t.squadra}</td><td>${t.girone}</td><td>${t.PT}</td><td>${t.GF}</td><td>${t.GS}</td><td>${dr}</td></tr>`;
        });
        tbody += "</tbody>";
        table.innerHTML = tbody;
        miglioriDiv.innerHTML = "";
        miglioriDiv.appendChild(table);
      }
    }

    function renderPartite() {
      const container = document.getElementById("programma");
      container.innerHTML = "";

      const campo = document.getElementById("campoFilter").value;
      const giorno = document.getElementById("giornoFilter").value;
      const girone = document.getElementById("gironeFilter").value;

      const filtered = partite
        .filter(p => (!campo || p.CAMPO === campo) &&
                     (!giorno || p.GIORNO === giorno) &&
                     (!girone || p.GIRONE === girone))
        .sort((a, b) => new Date(a.DATA + "T" + a.ORA) - new Date(b.DATA + "T" + b.ORA));

      const table = document.createElement("table");
      table.innerHTML = "<thead><tr><th>Giorno</th><th>Data</th><th>Ora</th><th>Campo</th><th>Girone</th><th>Squadra 1</th><th>Squadra 2</th><th>Risultato</th></tr></thead><tbody>" +
        filtered.map(p => `<tr><td>${p.GIORNO}</td><td>${p.DATA}</td><td>${p.ORA}</td><td>${p.CAMPO}</td><td>${p.GIRONE}</td><td>${p.SQUADRA1}</td><td>${p.SQUADRA2}</td><td>${p.RISULTATO}</td></tr>`).join("") +
        "</tbody>";
      container.appendChild(table);
    }

    function renderFaseFinale(data, squadreGironi) {
      const container = document.getElementById("faseFinale");
      container.innerHTML = "";
      const partite = data.sort((a, b) => new Date(a.DATA + "T" + a.ORA) - new Date(b.DATA + "T" + b.ORA));

      const table = document.createElement("table");
      table.innerHTML = "<thead><tr><th>Turno</th><th>Giorno</th><th>Ora</th><th>Campo</th><th>Squadra 1</th><th>Squadra 2</th><th>Risultato</th></tr></thead><tbody>" +
        partite.map(p => {
          const s1 = squadreGironi[p.SQUADRA1] || p.SQUADRA1;
          const s2 = squadreGironi[p.SQUADRA2] || p.SQUADRA2;
          return `<tr><td>${p.TURNO}</td><td>${p.GIORNO}</td><td>${p.ORA}</td><td>${p.CAMPO}</td><td>${s1}</td><td>${s2}</td><td>${p.RISULTATO}</td></tr>`;
        }).join("") + "</tbody>";
      container.appendChild(table);
    }

    async function init() {
      const res = await fetch(gironiUrl);
      const text = await res.text();
      const rows = text.trim().split("\n").map(r => r.split(","));
      const headers = rows.shift();

      partite = rows.map(r => Object.fromEntries(headers.map((h, i) => [h.trim(), r[i]?.trim() || ""])));

      const squadreGironi = {};
      partite.forEach(p => {
        if (!p.RISULTATO.includes("-")) return;
        const { g1, g2 } = parseRisultato(p.RISULTATO);
        if (!classifiche[p.GIRONE]) classifiche[p.GIRONE] = {};
        aggiornaClassifica(classifiche[p.GIRONE], p.SQUADRA1, g1, g2, g1 > g2 ? 3 : g1 === g2 ? 1 : 0);
        aggiornaClassifica(classifiche[p.GIRONE], p.SQUADRA2, g2, g1, g2 > g1 ? 3 : g1 === g2 ? 1 : 0);
      });

      renderClassifiche();
      renderPartite();

      // Mappatura posizioni â†’ squadre qualificate
      const posizioni = {};
      Object.keys(classifiche).forEach(g => {
        const classifica = Object.entries(classifiche[g]).sort((a, b) => {
          const drA = a[1].GF - a[1].GS;
          const drB = b[1].GF - b[1].GS;
          if (b[1].PT !== a[1].PT) return b[1].PT - a[1].PT;
          if (drB !== drA) return drB - drA;
          return b[1].GF - a[1].GF;
        });
        posizioni[`Prima classificata girone ${g}`] = classifica[0][0];
        posizioni[`Seconda classificata girone ${g}`] = classifica[1][0];
        if (classifica[2]) posizioni[`Terza classificata girone ${g}`] = classifica[2][0];
      });

      const miglioriTerze = Object.keys(classifiche).map(g => {
        const s = Object.entries(classifiche[g])[2];
        if (!s) return null;
        const diff = s[1].GF - s[1].GS;
        return { squadra: s[0], girone: g, PT: s[1].PT, GF: s[1].GF, GS: s[1].GS, diff };
      }).filter(Boolean).sort((a, b) => {
        if (b.PT !== a.PT) return b.PT - a.PT;
        if (b.diff !== a.diff) return b.diff - a.diff;
        return b.GF - a.GF;
      });

      posizioni["Prima migliore terza classificata"] = miglioriTerze[0].squadra;
      posizioni["Seconda migliore terza classificata"] = miglioriTerze[1].squadra;

      const resFinali = await fetch(finaliUrl);
      const textFinali = await resFinali.text();
      const rowsF = textFinali.trim().split("\n").map(r => r.split(","));
      const headersF = rowsF.shift();
      const partiteFinali = rowsF.map(r => Object.fromEntries(headersF.map((h, i) => [h.trim(), r[i]?.trim() || ""])));

      renderFaseFinale(partiteFinali, posizioni);

      // Popola i filtri
      const campi = [...new Set(partite.map(p => p.CAMPO))];
      const giorni = [...new Set(partite.map(p => p.GIORNO))];
      const gironi = [...new Set(partite.map(p => p.GIRONE))].sort();

      const campoSelect = document.getElementById("campoFilter");
      campi.forEach(c => campoSelect.innerHTML += `<option value="${c}">${c}</option>`);

      const giornoSelect = document.getElementById("giornoFilter");
      giorni.forEach(g => giornoSelect.innerHTML += `<option value="${g}">${g}</option>`);

      const gironeSelect = document.getElementById("gironeFilter");
      gironi.forEach(g => gironeSelect.innerHTML += `<option value="${g}">${g}</option>`);

      campoSelect.addEventListener("change", renderPartite);
      giornoSelect.addEventListener("change", renderPartite);
      gironeSelect.addEventListener("change", () => {
        renderPartite();
        renderClassifiche();
      });
    }

    init();
  </script>
</body>
</html>
