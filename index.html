<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Programma Torneo LUI&LEI</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      color: #333;
    }
    h2 {
      margin-top: 40px;
      background: #003366;
      color: #fff;
      padding: 10px;
      border-radius: 5px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 8px;
      text-align: center;
      border: 1px solid #ccc;
    }
    tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    .winner {
      font-weight: bold;
      background-color: #d1ffd1;
    }
    .filter {
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>Programma Torneo LUI&LEI</h1>

  <div class="filter">
    <label for="filtroGirone">Filtra per girone:</label>
    <select id="filtroGirone" onchange="filtraPartite()"></select>
    <label for="filtroCampo">Campo:</label>
    <select id="filtroCampo" onchange="filtraPartite()"></select>
    <label for="filtroGiorno">Giorno:</label>
    <select id="filtroGiorno" onchange="filtraPartite()"></select>
  </div>

  <h2>Fase a Gironi</h2>
  <div id="tabellaGironi"></div>

  <h2>Classifiche</h2>
  <div id="classifiche"></div>

  <h2>Fase Finale</h2>
  <div id="faseFinale"></div>

  <script>
    const urlGironi = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=1898554956&single=true&output=csv';
    const urlFinali = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=660358441&single=true&output=csv';

    let datiGironi = [];
    let datiFinali = [];

    async function caricaCSV(url) {
      const res = await fetch(url);
      const text = await res.text();
      const righe = text.trim().split('\n').map(r => r.split(','));
      const header = righe[0];
      const dati = righe.slice(1).map(r => Object.fromEntries(r.map((v,i) => [header[i], v])));
      return dati;
    }

    function filtraPartite() {
      const girone = document.getElementById('filtroGirone').value;
      const campo = document.getElementById('filtroCampo').value;
      const giorno = document.getElementById('filtroGiorno').value;

      const filtrati = datiGironi.filter(p =>
        (girone === '' || p.GIRONE === girone) &&
        (campo === '' || p.CAMPO === campo) &&
        (giorno === '' || p.GIORNO === giorno)
      );
      mostraPartite(filtrati);
    }

    function mostraPartite(partite) {
      partite.sort((a,b) => new Date(`${a.DATA}T${a.ORA}`) - new Date(`${b.DATA}T${b.ORA}`));
      const html = [`<table><thead><tr><th>Giorno</th><th>Ora</th><th>Campo</th><th>Girone</th><th>Squadra 1</th><th>Risultato</th><th>Squadra 2</th></tr></thead><tbody>` +
        partite.map(p => `<tr>
          <td>${p.GIORNO}</td>
          <td>${p.ORA}</td>
          <td>${p.CAMPO}</td>
          <td>${p.GIRONE}</td>
          <td>${p.SQUADRA1}</td>
          <td>${p.RISULTATO || '-'}</td>
          <td>${p.SQUADRA2}</td>
        </tr>`).join('') + '</tbody></table>'];
      document.getElementById('tabellaGironi').innerHTML = html;
    }

    function mostraClassifiche() {
      const gironi = [...new Set(datiGironi.map(p => p.GIRONE))];
      let html = '';
      for (const g of gironi) {
        const partite = datiGironi.filter(p => p.GIRONE === g && p.RISULTATO);
        const squadre = {};
        for (const p of partite) {
          const [g1, g2] = p.RISULTATO.split('-').map(Number);
          if (!squadre[p.SQUADRA1]) squadre[p.SQUADRA1] = { PG: 0, V: 0, N: 0, P: 0, GF: 0, GS: 0 };
          if (!squadre[p.SQUADRA2]) squadre[p.SQUADRA2] = { PG: 0, V: 0, N: 0, P: 0, GF: 0, GS: 0 };
          squadre[p.SQUADRA1].PG++;
          squadre[p.SQUADRA2].PG++;
          squadre[p.SQUADRA1].GF += g1;
          squadre[p.SQUADRA1].GS += g2;
          squadre[p.SQUADRA2].GF += g2;
          squadre[p.SQUADRA2].GS += g1;
          if (g1 > g2) { squadre[p.SQUADRA1].V++; squadre[p.SQUADRA2].P++; }
          else if (g1 < g2) { squadre[p.SQUADRA2].V++; squadre[p.SQUADRA1].P++; }
          else { squadre[p.SQUADRA1].N++; squadre[p.SQUADRA2].N++; }
        }
        const ordinata = Object.entries(squadre).map(([nome, stat]) => {
          const P = stat.V * 3 + stat.N;
          return { nome, ...stat, P, DR: stat.GF - stat.GS };
        }).sort((a, b) => b.P - a.P || b.DR - a.DR || b.GF - a.GF);

        html += `<h3>Girone ${g}</h3><table><thead><tr><th>Squadra</th><th>PG</th><th>V</th><th>N</th><th>P</th><th>GF</th><th>GS</th><th>DR</th><th>P</th></tr></thead><tbody>` +
          ordinata.map((s, i) => `<tr class="${i < 2 ? 'winner' : ''}"><td>${s.nome}</td><td>${s.PG}</td><td>${s.V}</td><td>${s.N}</td><td>${s.P}</td><td>${s.GF}</td><td>${s.GS}</td><td>${s.DR}</td><td>${s.P}</td></tr>`).join('') +
          '</tbody></table>';
      }
      document.getElementById('classifiche').innerHTML = html;
    }

    function mostraFinali() {
      datiFinali.sort((a,b) => new Date(`${a.DATA}T${a.ORA}`) - new Date(`${b.DATA}T${b.ORA}`));
      const html = `<table><thead><tr><th>Turno</th><th>Giorno</th><th>Ora</th><th>Campo</th><th>Squadra 1</th><th>Risultato</th><th>Squadra 2</th></tr></thead><tbody>` +
        datiFinali.map(p => {
          const [g1, g2] = (p.RISULTATO || '').split('-').map(Number);
          let s1 = p.SQUADRA1, s2 = p.SQUADRA2;
          let cls1 = '', cls2 = '';
          if (!isNaN(g1) && !isNaN(g2)) {
            if (g1 > g2) cls1 = 'winner';
            else if (g2 > g1) cls2 = 'winner';
          }
          return `<tr>
            <td>${p.TURNO}</td>
            <td>${p.GIORNO}</td>
            <td>${p.ORA}</td>
            <td>${p.CAMPO}</td>
            <td class="${cls1}">${s1}</td>
            <td>${p.RISULTATO || '-'}</td>
            <td class="${cls2}">${s2}</td>
          </tr>`;
        }).join('') + '</tbody></table>';
      document.getElementById('faseFinale').innerHTML = html;
    }

    async function init() {
      datiGironi = await caricaCSV(urlGironi);
      datiFinali = await caricaCSV(urlFinali);

      mostraPartite(datiGironi);
      mostraClassifiche();
      mostraFinali();

      const gironi = [...new Set(datiGironi.map(p => p.GIRONE))];
      const campi = [...new Set(datiGironi.map(p => p.CAMPO))];
      const giorni = [...new Set(datiGironi.map(p => p.GIORNO))];

      document.getElementById('filtroGirone').innerHTML = '<option value="">Tutti</option>' + gironi.map(g => `<option value="${g}">${g}</option>`).join('');
      document.getElementById('filtroCampo').innerHTML = '<option value="">Tutti</option>' + campi.map(c => `<option value="${c}">${c}</option>`).join('');
      document.getElementById('filtroGiorno').innerHTML = '<option value="">Tutti</option>' + giorni.map(g => `<option value="${g}">${g}</option>`).join('');
    }

    init();
  </script>
</body>
</html>