<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Torneo LUI&LEI - Programma e Classifiche</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f5f7fa;
      margin: 0;
      padding: 1rem;
      color: #222;
    }
    h2 {
      margin-top: 2rem;
      border-bottom: 2px solid #444;
      padding-bottom: 0.3rem;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 2rem;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 0.5rem;
      text-align: center;
      border: 1px solid #ccc;
    }
    th {
      background-color: #0066cc;
      color: white;
    }
    .filters {
      margin: 1rem 0;
    }
    .filters select {
      padding: 0.4rem;
      margin-right: 0.6rem;
    }
    .highlight {
      background-color: #d1ffd1 !important;
    }
    .top2 {
      background-color: #c6f7d4 !important;
    }
    .best-third {
      background-color: #e1ffe9 !important;
    }
  </style>
</head>
<body>

  <h1>Torneo LUI&LEI</h1>

  <div class="filters">
    <label>Filtro campo:</label>
    <select id="campoFilter">
      <option value="">Tutti</option>
    </select>
    <label>Filtro girone:</label>
    <select id="gironeFilter">
      <option value="">Tutti</option>
    </select>
    <label>Filtro giorno:</label>
    <select id="giornoFilter">
      <option value="">Tutti</option>
    </select>
  </div>

  <h2>Partite Fase a Gironi</h2>
  <table id="programmaTable">
    <thead>
      <tr>
        <th>Giorno</th><th>Data</th><th>Ora</th><th>Campo</th><th>Girone</th><th>Squadra 1</th><th>Squadra 2</th><th>Risultato</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Classifiche</h2>
  <div id="classificheContainer"></div>

  <h2>Fase Finale</h2>
  <table id="finaliTable">
    <thead>
      <tr>
        <th>Data</th><th>Ora</th><th>Turno</th><th>Campo</th><th>Squadra 1</th><th>Squadra 2</th><th>Risultato</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const URL_PROGRAMMA = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=1898554956&single=true&output=csv";
    const URL_FINALI = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=660358441&single=true&output=csv";

    let datiProgramma = [];
    let classifiche = {};
    let gironi = new Set();

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines.shift().split(',');
      return lines.map(line => {
        const values = line.split(',');
        return headers.reduce((obj, h, i) => {
          obj[h.trim()] = values[i]?.trim() || '';
          return obj;
        }, {});
      });
    }

    function caricaDati() {
      Promise.all([
        fetch(URL_PROGRAMMA).then(r => r.text()).then(parseCSV),
        fetch(URL_FINALI).then(r => r.text()).then(parseCSV)
      ]).then(([programma, finali]) => {
        datiProgramma = programma;
        costruisciFiltri();
        renderProgramma();
        calcolaClassifiche();
        renderClassifiche();
        renderFinali(finali);
      });
    }

    function costruisciFiltri() {
      const campoSel = document.getElementById('campoFilter');
      const gironeSel = document.getElementById('gironeFilter');
      const giornoSel = document.getElementById('giornoFilter');
      let campi = new Set(), giorni = new Set();

      datiProgramma.forEach(row => {
        campi.add(row.CAMPO);
        gironi.add(row.GIRONE);
        giorni.add(row.GIORNO);
      });

      [campoSel, gironeSel, giornoSel].forEach(select => select.innerHTML += [...(select === campoSel ? campi : (select === gironeSel ? gironi : giorni))].sort().map(v => `<option value="${v}">${v}</option>`).join(''));
      
      campoSel.onchange = gironeSel.onchange = giornoSel.onchange = () => renderProgramma();
    }

    function renderProgramma() {
      const tbody = document.querySelector('#programmaTable tbody');
      const campo = document.getElementById('campoFilter').value;
      const girone = document.getElementById('gironeFilter').value;
      const giorno = document.getElementById('giornoFilter').value;

      tbody.innerHTML = '';

      datiProgramma
        .filter(r => (!campo || r.CAMPO === campo) && (!girone || r.GIRONE === girone) && (!giorno || r.GIORNO === giorno))
        .sort((a, b) => (a.DATA + a.ORA).localeCompare(b.DATA + b.ORA))
        .forEach(r => {
          tbody.innerHTML += `
            <tr>
              <td>${r.GIORNO}</td>
              <td>${r.DATA}</td>
              <td>${r.ORA}</td>
              <td>${r.CAMPO}</td>
              <td>${r.GIRONE}</td>
              <td>${r.SQUADRA1}</td>
              <td>${r.SQUADRA2}</td>
              <td>${r.RISULTATO}</td>
            </tr>`;
        });
    }

    function calcolaClassifiche() {
      classifiche = {};
      datiProgramma.forEach(r => {
        if (!classifiche[r.GIRONE]) classifiche[r.GIRONE] = {};
        const res = r.RISULTATO.split('-').map(Number);
        if (res.length !== 2 || isNaN(res[0]) || isNaN(res[1])) return;

        const [s1, s2] = [r.SQUADRA1, r.SQUADRA2];
        const [g1, g2] = res;

        [s1, s2].forEach(s => {
          if (!classifiche[r.GIRONE][s]) classifiche[r.GIRONE][s] = { punti: 0, gf: 0, gs: 0, giocate: 0, vinte: 0, pareggi: 0, perse: 0 };
        });

        classifiche[r.GIRONE][s1].gf += g1;
        classifiche[r.GIRONE][s1].gs += g2;
        classifiche[r.GIRONE][s1].giocate++;

        classifiche[r.GIRONE][s2].gf += g2;
        classifiche[r.GIRONE][s2].gs += g1;
        classifiche[r.GIRONE][s2].giocate++;

        if (g1 > g2) {
          classifiche[r.GIRONE][s1].punti += 3;
          classifiche[r.GIRONE][s1].vinte++;
          classifiche[r.GIRONE][s2].perse++;
        } else if (g1 < g2) {
          classifiche[r.GIRONE][s2].punti += 3;
          classifiche[r.GIRONE][s2].vinte++;
          classifiche[r.GIRONE][s1].perse++;
        } else {
          classifiche[r.GIRONE][s1].punti += 1;
          classifiche[r.GIRONE][s2].punti += 1;
          classifiche[r.GIRONE][s1].pareggi++;
          classifiche[r.GIRONE][s2].pareggi++;
        }
      });
    }

    function renderClassifiche() {
      const container = document.getElementById('classificheContainer');
      const filtroGirone = document.getElementById('gironeFilter').value;
      container.innerHTML = '';

      for (let girone of gironi) {
        if (filtroGirone && filtroGirone !== girone) continue;
        const squadre = Object.entries(classifiche[girone] || {}).map(([squadra, stats]) => ({
          squadra, ...stats, diff: stats.gf - stats.gs
        })).sort((a, b) => b.punti - a.punti || b.diff - a.diff || b.gf - a.gf);

        const miglioriTerze = Object.entries(classifiche).map(([g, sq]) =>
          Object.entries(sq).map(([n, st]) => ({ girone: g, squadra: n, ...st }))
        ).flat().filter((_, i, arr) => {
          const gironeCount = {};
          return arr.filter(x => {
            if (!gironeCount[x.girone]) gironeCount[x.girone] = 0;
            return ++gironeCount[x.girone] === 3;
          }).includes(_);
        }).sort((a, b) => b.punti - a.punti || (b.gf - b.gs) - (a.gf - a.gs)).slice(0, 2).map(x => x.squadra);

        let html = `<h3>Girone ${girone}</h3><table><thead><tr><th>Squadra</th><th>Pt</th><th>Gi</th><th>V</th><th>N</th><th>P</th><th>GF</th><th>GS</th><th>Diff</th></tr></thead><tbody>`;
        squadre.forEach((s, i) => {
          const cls = i < 2 ? 'top2' : miglioriTerze.includes(s.squadra) ? 'best-third' : '';
          html += `<tr class="${cls}"><td>${s.squadra}</td><td>${s.punti}</td><td>${s.giocate}</td><td>${s.vinte}</td><td>${s.pareggi}</td><td>${s.perse}</td><td>${s.gf}</td><td>${s.gs}</td><td>${s.diff}</td></tr>`;
        });
        html += `</tbody></table>`;
        container.innerHTML += html;
      }
    }

    function renderFinali(finali) {
      const tbody = document.querySelector('#finaliTable tbody');
      tbody.innerHTML = '';

      const qualificati = {};
      for (let girone of gironi) {
        const squadre = Object.entries(classifiche[girone] || {}).map(([squadra, stats]) => ({
          squadra, ...stats, diff: stats.gf - stats.gs
        })).sort((a, b) => b.punti - a.punti || b.diff - a.diff || b.gf - a.gf);
        qualificati[`Prima classificata girone ${girone}`] = squadre[0]?.squadra || '';
        qualificati[`Seconda classificata girone ${girone}`] = squadre[1]?.squadra || '';
        if (squadre[2]) qualificati[`Terza classificata girone ${girone}`] = squadre[2]?.squadra;
      }

      // Migliori terze
      const miglioriTerze = Object.entries(classifiche).map(([g, sq]) =>
        Object.entries(sq).map(([n, st]) => ({ girone: g, squadra: n, ...st }))
      ).flat().filter((_, i, arr) => {
        const gironeCount = {};
        return arr.filter(x => {
          if (!gironeCount[x.girone]) gironeCount[x.girone] = 0;
          return ++gironeCount[x.girone] === 3;
        }).includes(_);
      }).sort((a, b) => b.punti - a.punti || (b.gf - b.gs) - (a.gf - a.gs)).slice(0, 2).map(x => x.squadra);

      qualificati['Prima migliore terza classificata'] = miglioriTerze[0];
      qualificati['Seconda migliore terza classificata'] = miglioriTerze[1];

      finali
        .sort((a, b) => (a.DATA + a.ORA).localeCompare(b.DATA + b.ORA))
        .forEach(r => {
          const squadra1 = qualificati[r.SQUADRA1] || r.SQUADRA1;
          const squadra2 = qualificati[r.SQUADRA2] || r.SQUADRA2;
          tbody.innerHTML += `
            <tr>
              <td>${r.DATA}</td>
              <td>${r.ORA}</td>
              <td>${r.TURNO || ''}</td>
              <td>${r.CAMPO}</td>
              <td>${squadra1}</td>
              <td>${squadra2}</td>
              <td>${r.RISULTATO}</td>
            </tr>`;
        });
    }

    caricaDati();
  </script>
</body>
</html>
