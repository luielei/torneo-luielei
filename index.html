<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Programma LUI&LEI</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    select, table { margin: 10px 0; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background-color: #f0f0f0; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Programma LUI&LEI</h1>

  <label for="campoFilter">Filtro Campo:</label>
  <select id="campoFilter"></select>

  <label for="giornoFilter">Filtro Giorno:</label>
  <select id="giornoFilter"></select>

  <label for="gironeFilter">Filtro Girone:</label>
  <select id="gironeFilter"></select>

  <h2>Partite</h2>
  <table id="programmaTable">
    <thead>
      <tr>
        <th>Data</th>
        <th>Ora</th>
        <th>Campo</th>
        <th>Squadra A</th>
        <th>Risultato</th>
        <th>Squadra B</th>
        <th>Girone</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Classifiche per Girone</h2>
  <div id="classifiche"></div>

  <script>
    const url = "https://gsx2json.com/api?id=1j-Yp9vy-ZVMn1DvMLrt6Wf5N1rgoxQxsCHiqe8gNuuc&sheet=Programma";

    let partite = [];

    fetch(url)
      .then(res => res.json())
      .then(json => {
        partite = json.rows.map(r => ({
          data: r["DATA"],
          ora: r["ORA"],
          campo: r["CAMPO"],
          squadraA: r["SQUADRA A"],
          squadraB: r["SQUADRA B"],
          golA: parseInt(r["GOL A"] || 0),
          golB: parseInt(r["GOL B"] || 0),
          girone: r["GIRONE"]
        })).filter(r => r.data && r.ora);

        populateFilters();
        updateTable();
        updateClassifiche();
      });

    function populateFilters() {
      const campoSet = new Set(), giornoSet = new Set(), gironeSet = new Set();
      partite.forEach(p => {
        campoSet.add(p.campo);
        giornoSet.add(p.data);
        gironeSet.add(p.girone);
      });
      fillSelect("campoFilter", campoSet);
      fillSelect("giornoFilter", giornoSet);
      fillSelect("gironeFilter", gironeSet);
      document.querySelectorAll('select').forEach(sel => sel.addEventListener('change', () => {
        updateTable();
        updateClassifiche();
      }));
    }

    function fillSelect(id, values) {
      const select = document.getElementById(id);
      select.innerHTML = '<option value="">Tutti</option>';
      Array.from(values).sort().forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        select.appendChild(opt);
      });
    }

    function updateTable() {
      const campo = campoFilter.value;
      const giorno = giornoFilter.value;
      const girone = gironeFilter.value;
      const tbody = document.querySelector("#programmaTable tbody");
      tbody.innerHTML = "";

      partite
        .filter(p => (!campo || p.campo === campo) && (!giorno || p.data === giorno) && (!girone || p.girone === girone))
        .sort((a, b) => (a.data + a.ora).localeCompare(b.data + b.ora))
        .forEach(p => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${p.data}</td>
            <td>${p.ora}</td>
            <td>${p.campo}</td>
            <td>${p.squadraA}</td>
            <td>${p.golA}-${p.golB}</td>
            <td>${p.squadraB}</td>
            <td>${p.girone}</td>`;
          tbody.appendChild(tr);
        });
    }

    function updateClassifiche() {
      const gironeSel = gironeFilter.value;
      const container = document.getElementById("classifiche");
      container.innerHTML = "";

      const gironi = gironeSel ? [gironeSel] : [...new Set(partite.map(p => p.girone))];

      gironi.forEach(girone => {
        const classifica = {};
        partite.filter(p => p.girone === girone && !isNaN(p.golA) && !isNaN(p.golB)).forEach(p => {
          [p.squadraA, p.squadraB].forEach(sq => {
            if (!classifica[sq]) classifica[sq] = { giocate: 0, punti: 0, fatti: 0, subiti: 0 };
          });
          classifica[p.squadraA].giocate++;
          classifica[p.squadraB].giocate++;
          classifica[p.squadraA].fatti += p.golA;
          classifica[p.squadraA].subiti += p.golB;
          classifica[p.squadraB].fatti += p.golB;
          classifica[p.squadraB].subiti += p.golA;
          if (p.golA > p.golB) classifica[p.squadraA].punti += 3;
          else if (p.golB > p.golA) classifica[p.squadraB].punti += 3;
          else { classifica[p.squadraA].punti += 1; classifica[p.squadraB].punti += 1; }
        });

        const entries = Object.entries(classifica).map(([squadra, stats]) => ({ squadra, ...stats }));
        entries.sort((a, b) => b.punti - a.punti || (b.fatti - b.subiti) - (a.fatti - a.subiti));

        const html = `
          <h3>Girone ${girone}</h3>
          <table>
            <thead>
              <tr><th>Squadra</th><th>Giocate</th><th>Punti</th><th>Gol Fatti</th><th>Gol Subiti</th><th>Diff</th></tr>
            </thead>
            <tbody>
              ${entries.map(e => `
                <tr>
                  <td>${e.squadra}</td>
                  <td>${e.giocate}</td>
                  <td>${e.punti}</td>
                  <td>${e.fatti}</td>
                  <td>${e.subiti}</td>
                  <td>${e.fatti - e.subiti}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
        container.innerHTML += html;
      });
    }
  </script>
</body>
</html>
