<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Torneo LUI&LEI - Fase a Gironi e Finali</title>
  <style>
    body {
      font-family: "Arial", sans-serif;
      background: #f8f9fa;
      color: #333;
      margin: 0;
      padding: 1rem;
    }
    h1 {
      text-align: center;
    }
    .filters {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    select {
      padding: 0.5rem;
      font-size: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 2rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.4rem;
      text-align: center;
    }
    th {
      background-color: #eee;
    }
    .highlight {
      background-color: #d4edda !important;
    }
    .section-title {
      margin-top: 2rem;
      font-size: 1.2rem;
      font-weight: bold;
      border-bottom: 2px solid #ccc;
      padding-bottom: 0.3rem;
    }
  </style>
</head>
<body>
  <h1>Torneo LUI&LEI - Fase a Gironi e Finali</h1>

  <div class="filters">
    <select id="campoFilter">
      <option value="">Tutti i campi</option>
    </select>
    <select id="giornoFilter">
      <option value="">Tutti i giorni</option>
    </select>
    <select id="gironeFilter">
      <option value="">Tutti i gironi</option>
    </select>
  </div>

  <div id="programma"></div>
  <div id="classifiche"></div>
  <div id="miglioriTerzeContainer"></div>
  <div id="faseFinaleContainer"></div>

  <script>
    const urlGironi = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=1898554956&single=true&output=csv&cachebuster=" + new Date().getTime();
    const urlFinali = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=660358441&single=true&output=csv&cachebuster=" + new Date().getTime();

    let miglioriTerze = [];
    let tutteLeTerze = [];
    let classificheGlobali = {};

    function parseCSV(data) {
      const lines = data.split("\n").filter(l => l.trim() !== "");
      const headers = lines[0].split(",");
      return lines.slice(1).map(line => {
        const values = line.split(",");
        const obj = {};
        headers.forEach((h, i) => obj[h.trim()] = values[i]?.trim());
        return obj;
      });
    }

    async function init() {
      const [gironiText, finaliText] = await Promise.all([
        fetch(urlGironi).then(r => r.text()),
        fetch(urlFinali).then(r => r.text())
      ]);

      const partiteGironi = parseCSV(gironiText);
      const partiteFinali = parseCSV(finaliText);

      aggiornaFiltri(partiteGironi);
      const classifiche = calcolaClassifiche(partiteGironi);
      classificheGlobali = classifiche;
      trovaTerze(classifiche);

      renderProgramma(partiteGironi, {});
      renderClassifiche(classifiche, null);
      renderMiglioriTerze();
      renderFaseFinale(partiteFinali);

      document.getElementById("campoFilter").addEventListener("change", () => {
        renderProgramma(partiteGironi, getFilters());
      });
      document.getElementById("giornoFilter").addEventListener("change", () => {
        renderProgramma(partiteGironi, getFilters());
      });
      document.getElementById("gironeFilter").addEventListener("change", () => {
        const girone = gironeFilter.value;
        renderProgramma(partiteGironi, getFilters());
        renderClassifiche(classifiche, girone);
        document.getElementById("miglioriTerzeContainer").style.display = girone ? "none" : "block";
      });
    }

    function getFilters() {
      return {
        campo: campoFilter.value,
        giorno: giornoFilter.value,
        girone: gironeFilter.value
      };
    }

    function renderFaseFinale(partiteFinale) {
      const container = document.getElementById("faseFinaleContainer");
      container.innerHTML = `<h2 class='section-title'>Fase Finale</h2>`;

      partiteFinale.sort((a, b) => new Date(`${a.DATA}T${a.ORA}`) - new Date(`${b.DATA}T${b.ORA}`));

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      thead.innerHTML = `<tr><th>Turno</th><th>Giorno</th><th>Ora</th><th>Campo</th><th>Squadra 1</th><th>Risultato</th><th>Squadra 2</th></tr>`;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      partiteFinale.forEach(p => {
        const r = p.RISULTATO || "";
        const row = document.createElement("tr");
        row.innerHTML = `<td>${p.TURNO}</td><td>${p.GIORNO}</td><td>${p.ORA}</td><td>${p.CAMPO}</td><td>${squadraQualificata(p.SQUADRA1)}</td><td>${r}</td><td>${squadraQualificata(p.SQUADRA2)}</td>`;
        tbody.appendChild(row);
      });

      table.appendChild(tbody);
      container.appendChild(table);
    }

    function squadraQualificata(nome) {
      if (!nome) return "";
      const match = nome.match(/(Prima|Seconda|Terza|Migliore|Seconda migliore) classificata girone ([A-H])/i);
      if (match) {
        const posizione = match[1].toLowerCase();
        const girone = match[2].toUpperCase();
        const classifica = Object.values(classificheGlobali[girone] || {}).sort((a, b) => b.punti - a.punti || b.diff - a.diff || b.gf - a.gf);
        if (posizione.includes("prima")) return classifica[0]?.squadra || nome;
        if (posizione.includes("seconda")) return classifica[1]?.squadra || nome;
        if (posizione.includes("terza")) return classifica[2]?.squadra || nome;
      }
      if (nome.includes("Prima migliore")) return miglioriTerze[0]?.squadra || nome;
      if (nome.includes("Seconda migliore")) return miglioriTerze[1]?.squadra || nome;
      return nome;
    }

    // Reuse functions: aggiornaFiltri, calcolaClassifiche, trovaTerze, renderProgramma, renderClassifiche, renderMiglioriTerze
    // (Same as already defined in the provided file)
  </script>
</body>
</html>
