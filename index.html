<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Torneo LUI&LEI</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
      color: #333;
    }
    h2 {
      margin-top: 40px;
      color: #222;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
      background: #fff;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #eee;
    }
    .highlight {
      background-color: #d4edda;
      font-weight: bold;
    }
    .filter-group {
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>Torneo LUI&LEI - Programma e Risultati</h1>

  <div class="filter-group">
    <label for="campoFilter">Campo:</label>
    <select id="campoFilter">
      <option value="">Tutti</option>
    </select>

    <label for="giornoFilter">Giorno:</label>
    <select id="giornoFilter">
      <option value="">Tutti</option>
    </select>

    <label for="gironeFilter">Girone:</label>
    <select id="gironeFilter">
      <option value="">Tutti</option>
    </select>
  </div>

  <h2>Partite Fase a Gironi</h2>
  <div id="programma"></div>

  <h2>Classifiche</h2>
  <div id="classifiche"></div>

  <h2 id="migliori-terze-title">Classifica Migliori Terze</h2>
  <div id="migliori-terze"></div>

  <script>
    const programmaURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=1898554956&single=true&output=csv";
    const gironi = {};
    const miglioriTerzeGlobal = [];

    async function loadCSV(url) {
      const response = await fetch(url + "&cachebuster=" + new Date().getTime());
      const text = await response.text();
      const rows = text.trim().split("\n").map(r => r.split(","));
      const headers = rows[0];
      return rows.slice(1).map(r => Object.fromEntries(r.map((v, i) => [headers[i].trim(), v.trim()])));
    }

    function renderProgramma(partite) {
      const container = document.getElementById("programma");
      const campoSet = new Set();
      const giornoSet = new Set();
      const gironeSet = new Set();

      partite.sort((a, b) => new Date(`${a.DATA} ${a.ORA}`) - new Date(`${b.DATA} ${b.ORA}`));

      container.innerHTML = `<table><thead><tr><th>Giorno</th><th>Data</th><th>Ora</th><th>Campo</th><th>Girone</th><th>Squadra 1</th><th>Risultato</th><th>Squadra 2</th></tr></thead><tbody>
        ${partite.map(p => {
          campoSet.add(p.CAMPO);
          giornoSet.add(p.GIORNO);
          if (p.GIRONE) gironeSet.add(p.GIRONE);
          return `<tr data-campo="${p.CAMPO}" data-giorno="${p.GIORNO}" data-girone="${p.GIRONE}">
            <td>${p.GIORNO}</td><td>${p.DATA}</td><td>${p.ORA}</td><td>${p.CAMPO}</td><td>${p.GIRONE}</td>
            <td>${p.SQUADRA1}</td><td>${p.RISULTATO}</td><td>${p.SQUADRA2}</td></tr>`;
        }).join("")}
      </tbody></table>`;

      populateFilter("campoFilter", campoSet);
      populateFilter("giornoFilter", giornoSet);
      populateFilter("gironeFilter", gironeSet);
    }

    function populateFilter(id, values) {
      const select = document.getElementById(id);
      select.innerHTML = `<option value="">Tutti</option>` + [...values].sort().map(v => `<option value="${v}">${v}</option>`).join("");
    }

    function applyFilters() {
      const campo = document.getElementById("campoFilter").value;
      const giorno = document.getElementById("giornoFilter").value;
      const girone = document.getElementById("gironeFilter").value;
      document.querySelectorAll("#programma table tbody tr").forEach(row => {
        const match = (!campo || row.dataset.campo === campo)
          && (!giorno || row.dataset.giorno === giorno)
          && (!girone || row.dataset.girone === girone);
        row.style.display = match ? "" : "none";
      });

      document.querySelectorAll(".classifica-table").forEach(tbl => {
        const show = !girone || tbl.dataset.girone === girone;
        tbl.style.display = show ? "" : "none";
      });

      document.getElementById("migliori-terze").style.display = girone ? "none" : "";
    }

    function calcolaClassifiche(partite) {
      const stats = {};
      partite.forEach(p => {
        const g = p.GIRONE;
        if (!g) return;
        if (!stats[g]) stats[g] = {};
        [p.IDSQUADRA1, p.IDSQUADRA2].forEach(id => {
          if (!stats[g][id]) stats[g][id] = { id, nome: "", punti: 0, giocate: 0, vinte: 0, pareggi: 0, perse: 0, gf: 0, gs: 0 };
        });
        const s1 = stats[g][p.IDSQUADRA1];
        const s2 = stats[g][p.IDSQUADRA2];
        s1.nome = p.SQUADRA1;
        s2.nome = p.SQUADRA2;
        const [g1, g2] = p.RISULTATO.split("-").map(Number);
        if (isNaN(g1) || isNaN(g2)) return;
        s1.gf += g1; s1.gs += g2; s1.giocate++;
        s2.gf += g2; s2.gs += g1; s2.giocate++;
        if (g1 > g2) { s1.vinte++; s1.punti += 3; s2.perse++; }
        else if (g1 < g2) { s2.vinte++; s2.punti += 3; s1.perse++; }
        else { s1.pareggi++; s2.pareggi++; s1.punti++; s2.punti++; }
      });
      return stats;
    }

    function renderClassifiche(stats) {
      const container = document.getElementById("classifiche");
      container.innerHTML = "";
      const terze = [];

      Object.entries(stats).sort().forEach(([girone, squadre]) => {
        const arr = Object.values(squadre);
        arr.forEach(s => s.dr = s.gf - s.gs);
        arr.sort((a, b) => b.punti - a.punti || b.dr - a.dr || b.gf - a.gf);
        const table = document.createElement("table");
        table.classList.add("classifica-table");
        table.dataset.girone = girone;
        table.innerHTML = `<thead><tr><th>Girone ${girone}</th><th>PG</th><th>V</th><th>N</th><th>P</th><th>GF</th><th>GS</th><th>DR</th><th>Punti</th></tr></thead><tbody>
          ${arr.map((s, i) => {
            const cl = (i === 0 || i === 1) ? "highlight" : "";
            return `<tr class="${cl}" data-id="${s.id}">
              <td>${s.nome}</td><td>${s.giocate}</td><td>${s.vinte}</td><td>${s.pareggi}</td><td>${s.perse}</td>
              <td>${s.gf}</td><td>${s.gs}</td><td>${s.dr}</td><td>${s.punti}</td></tr>`;
          }).join("")}</tbody>`;
        container.appendChild(table);

        if (arr.length >= 3) terze.push(arr[2]);
      });

      terze.forEach(t => t.dr = t.gf - t.gs);
      terze.sort((a, b) => b.punti - a.punti || b.dr - a.dr || b.gf - a.gf);
      miglioriTerzeGlobal.splice(0, miglioriTerzeGlobal.length, ...terze);
      renderMiglioriTerze();
    }

    function renderMiglioriTerze() {
      const container = document.getElementById("migliori-terze");
      container.innerHTML = `<table><thead><tr><th>Squadra</th><th>PG</th><th>V</th><th>N</th><th>P</th><th>GF</th><th>GS</th><th>DR</th><th>Punti</th></tr></thead><tbody>
        ${miglioriTerzeGlobal.map((s, i) => `<tr class="${i < 2 ? "highlight" : ""}"><td>${s.nome}</td><td>${s.giocate}</td><td>${s.vinte}</td><td>${s.pareggi}</td><td>${s.perse}</td><td>${s.gf}</td><td>${s.gs}</td><td>${s.dr}</td><td>${s.punti}</td></tr>`).join("")}
      </tbody></table>`;

      evidenziaMiglioriTerze();
    }

    function evidenziaMiglioriTerze() {
      const topTerze = new Set(miglioriTerzeGlobal.slice(0, 2).map(s => s.id));
      document.querySelectorAll(".classifica-table").forEach(table => {
        table.querySelectorAll("tbody tr").forEach(row => {
          const id = row.dataset.id;
          if (topTerze.has(id)) row.classList.add("highlight");
        });
      });
    }

    async function init() {
      const partite = await loadCSV(programmaURL);
      renderProgramma(partite);
      const stats = calcolaClassifiche(partite);
      renderClassifiche(stats);
      applyFilters();
    }

    document.getElementById("campoFilter").addEventListener("change", applyFilters);
    document.getElementById("giornoFilter").addEventListener("change", applyFilters);
    document.getElementById("gironeFilter").addEventListener("change", applyFilters);

    init();
  </script>
</body>
</html>
