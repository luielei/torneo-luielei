<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fase Finale - LUI&LEI</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      padding: 20px;
    }
    h2 {
      margin-top: 40px;
      color: #333;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 40px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #004080;
      color: white;
    }
    .vincente {
      font-weight: bold;
      background-color: #c8e6c9;
    }
  </style>
</head>
<body>

  <h2>Fase Finale</h2>
  <div id="faseFinale"></div>

  <script>
    const finaliCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=660358441&single=true&output=csv&cachebuster=" + new Date().getTime();

    function fetchCSV(url) {
      return fetch(url)
        .then(res => res.text())
        .then(text => {
          const rows = text.trim().split('\n').map(r => r.split(','));
          const headers = rows.shift();
          return rows.map(row => {
            const obj = {};
            headers.forEach((h, i) => obj[h.trim()] = row[i]?.trim() || '');
            return obj;
          });
        });
    }

    function getVincente(risultato, squadra1, squadra2) {
      if (!risultato || !risultato.includes("-")) return "";
      const [g1, g2] = risultato.split("-").map(Number);
      if (g1 > g2) return squadra1;
      if (g2 > g1) return squadra2;
      return ""; // pareggio, caso non ammesso in fase a eliminazione diretta
    }

    function renderFaseFinale(partite) {
      const turniOrdine = [
        "Ottavo di finale 1", "Ottavo di finale 2", "Ottavo di finale 3", "Ottavo di finale 4",
        "Ottavo di finale 5", "Ottavo di finale 6", "Ottavo di finale 7", "Ottavo di finale 8",
        "Quarto di finale 1", "Quarto di finale 2", "Quarto di finale 3", "Quarto di finale 4",
        "Semifinale 1", "Semifinale 2",
        "Finale 3Â° posto", "Finale"
      ];

      // Ordina per TURNO, poi ORA
      partite.sort((a, b) => {
        const t1 = turniOrdine.indexOf(a.TURNO);
        const t2 = turniOrdine.indexOf(b.TURNO);
        if (t1 !== t2) return t1 - t2;
        return a.ORA.localeCompare(b.ORA);
      });

      // Mappa per salvare le vincitrici
      const vincitori = {};

      // Sostituisce i nomi dinamicamente se sono riferimenti a turni precedenti
      function resolveSquadra(nome) {
        return vincitori[nome] || nome;
      }

      let html = `<table>
        <tr>
          <th>Turno</th>
          <th>Data</th>
          <th>Ora</th>
          <th>Campo</th>
          <th>Squadra 1</th>
          <th>Risultato</th>
          <th>Squadra 2</th>
        </tr>`;

      partite.forEach(p => {
        const squadra1 = resolveSquadra(p.SQUADRA1);
        const squadra2 = resolveSquadra(p.SQUADRA2);
        const vincente = getVincente(p.RISULTATO, squadra1, squadra2);
        if (vincente) vincitori[`Vincente ${p.TURNO}`] = vincente;

        const s1Class = squadra1 === vincente ? "vincente" : "";
        const s2Class = squadra2 === vincente ? "vincente" : "";

        html += `<tr>
          <td>${p.TURNO}</td>
          <td>${p.DATA}</td>
          <td>${p.ORA}</td>
          <td>${p.CAMPO}</td>
          <td class="${s1Class}">${squadra1}</td>
          <td>${p.RISULTATO}</td>
          <td class="${s2Class}">${squadra2}</td>
        </tr>`;
      });

      html += `</table>`;
      document.getElementById("faseFinale").innerHTML = html;
    }

    async function init() {
      const partiteFinali = await fetchCSV(finaliCSV);
      renderFaseFinale(partiteFinali);
    }

    init();
  </script>
</body>
</html>
