<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Programma Torneo LUI&LEI</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { margin-bottom: 10px; }
    .filters { margin-bottom: 20px; }
    .filters label { margin-right: 10px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 40px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f4f4f4; }
  </style>
</head>
<body>
  <h1>Programma Torneo LUI&amp;LEI</h1>
  <div class="filters">
    <label for="campo">Campo:</label>
    <select id="campo"></select>

    <label for="girone">Girone:</label>
    <select id="girone"></select>

    <label for="giorno">Giorno:</label>
    <select id="giorno"></select>
  </div>

  <table id="programma">
    <thead>
      <tr>
        <th>Giorno</th>
        <th>Data</th>
        <th>Ora</th>
        <th>Campo</th>
        <th>Girone</th>
        <th>Squadra 1</th>
        <th>Risultato</th>
        <th>Squadra 2</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="classifiche"></div>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=1898554956&single=true&output=csv";
    let data = [];

    function createFilters() {
      const campoSet = new Set();
      const gironeSet = new Set();
      const giornoSet = new Set();

      data.forEach(row => {
        campoSet.add(row["CAMPO"]);
        gironeSet.add(row["GIRONE"]);
        giornoSet.add(row["GIORNO"]);
      });

      const campoSelect = document.getElementById("campo");
      const gironeSelect = document.getElementById("girone");
      const giornoSelect = document.getElementById("giorno");

      [campoSelect, gironeSelect, giornoSelect].forEach(select => {
        select.innerHTML = '<option value="">Tutti</option>';
      });

      campoSet.forEach(value => campoSelect.innerHTML += `<option value="${value}">${value}</option>`);
      gironeSet.forEach(value => gironeSelect.innerHTML += `<option value="${value}">${value}</option>`);
      giornoSet.forEach(value => giornoSelect.innerHTML += `<option value="${value}">${value}</option>`);

      [campoSelect, gironeSelect, giornoSelect].forEach(select => {
        select.addEventListener("change", renderTable);
      });
    }

    function renderTable() {
      const campo = document.getElementById("campo").value;
      const girone = document.getElementById("girone").value;
      const giorno = document.getElementById("giorno").value;

      const tbody = document.querySelector("#programma tbody");
      tbody.innerHTML = "";

      const filtered = data.filter(row => {
        return (!campo || row["CAMPO"] === campo) &&
               (!girone || row["GIRONE"] === girone) &&
               (!giorno || row["GIORNO"] === giorno);
      });

      filtered.sort((a, b) => {
        return new Date(a["DATA"] + ' ' + a["ORA"]) - new Date(b["DATA"] + ' ' + b["ORA"]);
      });

      filtered.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row["GIORNO"]}</td>
          <td>${row["DATA"]}</td>
          <td>${row["ORA"]}</td>
          <td>${row["CAMPO"]}</td>
          <td>${row["GIRONE"]}</td>
          <td>${row["SQUADRA1"]}</td>
          <td>${row["RISULTATO"]}</td>
          <td>${row["SQUADRA2"]}</td>
        `;
        tbody.appendChild(tr);
      });

      renderClassifiche();
    }

    function renderClassifiche() {
      const container = document.getElementById("classifiche");
      container.innerHTML = "";

      const gironi = [...new Set(data.map(row => row["GIRONE"]))];

      gironi.forEach(girone => {
        const partite = data.filter(row => row["GIRONE"] === girone && row["RISULTATO"].includes("-"));

        const punteggi = {};

        partite.forEach(row => {
          const [gol1, gol2] = row["RISULTATO"].split("-").map(Number);
          const s1 = row["SQUADRA1"];
          const s2 = row["SQUADRA2"];

          if (!punteggi[s1]) punteggi[s1] = { P: 0, GF: 0, GS: 0 };
          if (!punteggi[s2]) punteggi[s2] = { P: 0, GF: 0, GS: 0 };

          punteggi[s1].GF += gol1;
          punteggi[s1].GS += gol2;
          punteggi[s2].GF += gol2;
          punteggi[s2].GS += gol1;

          if (gol1 > gol2) punteggi[s1].P += 3;
          else if (gol1 < gol2) punteggi[s2].P += 3;
          else { punteggi[s1].P += 1; punteggi[s2].P += 1; }
        });

        const rows = Object.entries(punteggi).map(([squadra, val]) => {
          return { squadra, ...val, DR: val.GF - val.GS };
        }).sort((a, b) => b.P - a.P || b.DR - a.DR || b.GF - a.GF);

        const table = document.createElement("table");
        table.innerHTML = `
          <thead><tr><th colspan="5">Classifica Girone ${girone}</th></tr>
          <tr><th>Squadra</th><th>Punti</th><th>GF</th><th>GS</th><th>DR</th></tr></thead>
          <tbody>
            ${rows.map(r => `<tr><td>${r.squadra}</td><td>${r.P}</td><td>${r.GF}</td><td>${r.GS}</td><td>${r.DR}</td></tr>`).join("")}
          </tbody>`;

        container.appendChild(table);
      });
    }

    Papa.parse(csvUrl, {
      download: true,
      header: true,
      complete: function(results) {
        data = results.data.filter(row => row["SQUADRA1"] && row["SQUADRA2"]);
        createFilters();
        renderTable();
      }
    });
  </script>
</body>
</html>