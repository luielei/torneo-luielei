<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Mini-Torneo Lui & Lei 2025</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h2 { margin-top: 40px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    .first { background-color: #d1ffd1; }
    .third-best { background-color: #ffe3a3; }
    select { margin-bottom: 20px; }
  </style>
</head>
<body>
  <h1>Mini-Torneo Lui & Lei 2025</h1>
  <label for="gironeSelect">Seleziona girone:</label>
  <select id="gironeSelect" onchange="filterByGirone()">
    <option value="ALL">Tutti i gironi</option>
    <option value="A">Girone A</option>
    <option value="B">Girone B</option>
    <option value="C">Girone C</option>
    <option value="D">Girone D</option>
    <option value="E">Girone E</option>
    <option value="F">Girone F</option>
    <option value="G">Girone G</option>
  </select>

  <h2>Programma Partite</h2>
  <table id="programmaTable"></table>

  <h2>Classifiche Gironi</h2>
  <div id="classificheContainer"></div>

  <h2>Fase Finale</h2>
  <table id="finaliTable"></table>

  <script>
    async function loadCSV(url) {
      const response = await fetch(url);
      const text = await response.text();
      const rows = text.trim().split('\n').map(row => row.split(','));
      const headers = rows[0];
      return rows.slice(1).map(row => Object.fromEntries(row.map((cell, i) => [headers[i], cell])));
    }

    async function loadData() {
      const programma = await loadCSV('https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=1898554956&single=true&output=csv');
      const finali = await loadCSV('https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=660358441&single=true&output=csv');
      renderProgramma(programma, 'ALL');
      renderClassifiche(programma, 'ALL');
      renderFinali(finali);
      window.datiProgramma = programma;
    }

    function renderProgramma(programma, girone) {
      const table = document.getElementById('programmaTable');
      let html = '<tr><th>Giorno</th><th>Data</th><th>Ora</th><th>Campo</th><th>Girone</th><th>Squadra 1</th><th>Squadra 2</th><th>Risultato</th></tr>';
      for (const match of programma) {
        if (girone === 'ALL' || match.GIRONE === girone) {
          html += `<tr><td>${match.GIORNO}</td><td>${match.DATA}</td><td>${match.ORA}</td><td>${match.CAMPO}</td><td>${match.GIRONE}</td><td>${match.SQUADRA1}</td><td>${match.SQUADRA2}</td><td>${match.RISULTATO}</td></tr>`;
        }
      }
      table.innerHTML = html;
    }

    function computeClassifiche(programma) {
      const stats = {};
      for (const match of programma) {
        const girone = match.GIRONE;
        const [gf1, gf2] = (match.RISULTATO || '').split('-').map(Number);
        if (isNaN(gf1) || isNaN(gf2)) continue;
        const [s1, s2] = [match.SQUADRA1, match.SQUADRA2];
        for (const [team, gf, gs, pt] of [[s1, gf1, gf2, gf1 > gf2 ? 3 : gf1 === gf2 ? 1 : 0], [s2, gf2, gf1, gf2 > gf1 ? 3 : gf1 === gf2 ? 1 : 0]]) {
          stats[girone] = stats[girone] || {};
          stats[girone][team] = stats[girone][team] || { Squadra: team, Partite: 0, Punti: 0, GolFatti: 0, GolSubiti: 0 };
          const rec = stats[girone][team];
          rec.Partite += 1;
          rec.Punti += pt;
          rec.GolFatti += gf;
          rec.GolSubiti += gs;
        }
      }
      const out = [];
      for (const girone in stats) {
        for (const team in stats[girone]) {
          const rec = stats[girone][team];
          rec.GIRONE = girone;
          rec.DiffReti = rec.GolFatti - rec.GolSubiti;
          out.push(rec);
        }
      }
      return out.sort((a, b) => a.GIRONE.localeCompare(b.GIRONE) || b.Punti - a.Punti || b.DiffReti - a.DiffReti || b.GolFatti - a.GolFatti);
    }

    function renderClassifiche(programma, girone) {
      const classifiche = computeClassifiche(programma);
      const container = document.getElementById('classificheContainer');
      container.innerHTML = '';
      const gironi = [...new Set(classifiche.map(c => c.GIRONE))];
      const terze = {};
      for (const g of gironi) {
        const teams = classifiche.filter(c => c.GIRONE === g);
        if (girone !== 'ALL' && g !== girone) continue;
        let html = `<h3>Girone ${g}</h3><table><tr><th>Squadra</th><th>Partite</th><th>Punti</th><th>Gol Fatti</th><th>Gol Subiti</th><th>Diff. Reti</th></tr>`;
        teams.forEach((team, i) => {
          let rowClass = '';
          if (i === 0 || i === 1) rowClass = 'class="first"';
          if (i === 2) terze[team.Squadra] = g;
          html += `<tr ${rowClass}><td>${team.Squadra}</td><td>${team.Partite}</td><td>${team.Punti}</td><td>${team.GolFatti}</td><td>${team.GolSubiti}</td><td>${team.DiffReti}</td></tr>`;
        });
        html += '</table>';
        container.innerHTML += html;
      }
      const thirdTeams = classifiche.filter(t => Object.keys(terze).includes(t.Squadra));
      const bestThirds = thirdTeams.sort((a, b) => b.Punti - a.Punti || b.DiffReti - a.DiffReti || b.GolFatti - a.GolFatti).slice(0, 2);
      for (const team of bestThirds) {
        const rows = document.querySelectorAll('table tr');
        for (const row of rows) {
          if (row.innerText.includes(team.Squadra)) {
            if (!row.classList.contains('first')) row.classList.add('third-best');
          }
        }
      }
    }

    function renderFinali(finali) {
      const table = document.getElementById('finaliTable');
      let html = '<tr><th>Giorno</th><th>Data</th><th>Ora</th><th>Campo</th><th>Fase</th><th>Turno</th><th>Squadra 1</th><th>Squadra 2</th><th>Risultato</th></tr>';
      for (const match of finali) {
        html += `<tr><td>${match.GIORNO}</td><td>${match.DATA}</td><td>${match.ORA}</td><td>${match.CAMPO}</td><td>${match['FASE FINALE']}</td><td>${match.TURNO}</td><td>${match.SQUADRA1}</td><td>${match.SQUADRA2}</td><td>${match.RISULTATO}</td></tr>`;
      }
      table.innerHTML = html;
    }

    function filterByGirone() {
      const girone = document.getElementById('gironeSelect').value;
      renderProgramma(window.datiProgramma, girone);
      renderClassifiche(window.datiProgramma, girone);
    }

    loadData();
  </script>
</body>
</html>
