<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Torneo LUI&LEI - Programma & Classifiche</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f6f9fc;
      color: #333;
      padding: 20px;
    }

    h2 {
      margin-top: 40px;
      color: #1a73e8;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      margin-bottom: 30px;
    }

    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: center;
    }

    th {
      background-color: #e8f0fe;
    }

    .highlight {
      background-color: #c8e6c9 !important;
      font-weight: bold;
    }

    .filter-group {
      margin-bottom: 20px;
    }

    .filter-group label {
      margin-right: 10px;
    }

    .winner {
      background-color: #d1ffd1;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Torneo LUI&LEI</h1>

  <div class="filter-group">
    <label for="campoFilter">Campo:</label>
    <select id="campoFilter">
      <option value="">Tutti</option>
    </select>

    <label for="giornoFilter">Giorno:</label>
    <select id="giornoFilter">
      <option value="">Tutti</option>
    </select>

    <label for="gironeFilter">Girone:</label>
    <select id="gironeFilter">
      <option value="">Tutti</option>
    </select>
  </div>

  <h2>Programma Partite</h2>
  <table id="programmaTable">
    <thead>
      <tr>
        <th>Giorno</th>
        <th>Data</th>
        <th>Ora</th>
        <th>Campo</th>
        <th>Girone</th>
        <th>Squadra 1</th>
        <th>Risultato</th>
        <th>Squadra 2</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Classifiche</h2>
  <div id="classificheContainer"></div>

  <h2>Fase Finale</h2>
  <table id="finaliTable">
    <thead>
      <tr>
        <th>Turno</th>
        <th>Data</th>
        <th>Ora</th>
        <th>Campo</th>
        <th>Squadra 1</th>
        <th>Risultato</th>
        <th>Squadra 2</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const PROGRAMMA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=1898554956&single=true&output=csv';
    const FINALI_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=660358441&single=true&output=csv';

    async function loadCSV(url) {
      const bustUrl = url + '&cachebust=' + Date.now();
      const response = await fetch(bustUrl);
      const text = await response.text();
      const rows = text.trim().split('\n').map(row => row.split(','));
      const headers = rows.shift();
      return rows.map(row => Object.fromEntries(row.map((cell, i) => [headers[i], cell])));
    }

    function createOption(select, value) {
      const opt = document.createElement('option');
      opt.value = value;
      opt.textContent = value;
      select.appendChild(opt);
    }

    function updateFilters(data) {
      const campoFilter = document.getElementById('campoFilter');
      const giornoFilter = document.getElementById('giornoFilter');
      const gironeFilter = document.getElementById('gironeFilter');

      const campi = new Set();
      const giorni = new Set();
      const gironi = new Set();

      data.forEach(row => {
        campi.add(row.CAMPO);
        giorni.add(row.GIORNO);
        gironi.add(row.GIRONE);
      });

      [campoFilter, giornoFilter, gironeFilter].forEach(select => {
        while (select.children.length > 1) select.removeChild(select.lastChild);
      });

      [...campi].sort().forEach(c => createOption(campoFilter, c));
      [...giorni].sort().forEach(c => createOption(giornoFilter, c));
      [...gironi].sort().forEach(c => createOption(gironeFilter, c));
    }

    function renderProgramma(data) {
      const tbody = document.querySelector('#programmaTable tbody');
      tbody.innerHTML = '';

      const campo = document.getElementById('campoFilter').value;
      const giorno = document.getElementById('giornoFilter').value;
      const girone = document.getElementById('gironeFilter').value;

      const filtered = data
        .filter(row => (!campo || row.CAMPO === campo) &&
                       (!giorno || row.GIORNO === giorno) &&
                       (!girone || row.GIRONE === girone))
        .sort((a, b) => new Date(`${a.DATA} ${a.ORA}`) - new Date(`${b.DATA} ${b.ORA}`));

      filtered.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.GIORNO}</td>
          <td>${row.DATA}</td>
          <td>${row.ORA}</td>
          <td>${row.CAMPO}</td>
          <td>${row.GIRONE}</td>
          <td>${row.SQUADRA1}</td>
          <td>${row.RISULTATO}</td>
          <td>${row.SQUADRA2}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function calculateClassifiche(data) {
      const stats = {};
      data.forEach(row => {
        if (!row.RISULTATO.includes('-')) return;
        const [g1, g2] = row.RISULTATO.split('-').map(Number);
        const girone = row.GIRONE;
        const s1 = row.SQUADRA1, s2 = row.SQUADRA2;

        if (!stats[girone]) stats[girone] = {};
        [s1, s2].forEach(sq => {
          if (!stats[girone][sq]) stats[girone][sq] = { P: 0, F: 0, S: 0, V: 0, N: 0, Pts: 0 };
        });

        stats[girone][s1].F += g1;
        stats[girone][s1].S += g2;
        stats[girone][s2].F += g2;
        stats[girone][s2].S += g1;

        stats[girone][s1].P++;
        stats[girone][s2].P++;

        if (g1 > g2) {
          stats[girone][s1].V++;
          stats[girone][s1].Pts += 3;
        } else if (g1 < g2) {
          stats[girone][s2].V++;
          stats[girone][s2].Pts += 3;
        } else {
          stats[girone][s1].N++;
          stats[girone][s2].N++;
          stats[girone][s1].Pts += 1;
          stats[girone][s2].Pts += 1;
        }
      });
      return stats;
    }

    function renderClassifiche(stats) {
      const container = document.getElementById('classificheContainer');
      container.innerHTML = '';
      const filterGirone = document.getElementById('gironeFilter').value;

      Object.keys(stats).sort().forEach(girone => {
        if (filterGirone && filterGirone !== girone) return;
        const teams = Object.entries(stats[girone])
          .map(([squadra, val]) => ({ squadra, ...val }))
          .sort((a, b) => b.Pts - a.Pts || (b.F - b.S) - (a.F - a.S));

        const table = document.createElement('table');
        table.innerHTML = `
          <caption><strong>Girone ${girone}</strong></caption>
          <thead>
            <tr><th>Squadra</th><th>PG</th><th>V</th><th>N</th><th>P</th><th>GF</th><th>GS</th><th>Diff</th><th>Punti</th></tr>
          </thead>
          <tbody></tbody>
        `;

        teams.forEach((t, i) => {
          const tr = document.createElement('tr');
          if (i < 2 || (i === 2 && filterGirone === '')) tr.classList.add('highlight');
          tr.innerHTML = `
            <td>${t.squadra}</td>
            <td>${t.P}</td>
            <td>${t.V}</td>
            <td>${t.N}</td>
            <td>${t.P - t.V - t.N}</td>
            <td>${t.F}</td>
            <td>${t.S}</td>
            <td>${t.F - t.S}</td>
            <td>${t.Pts}</td>
          `;
          table.querySelector('tbody').appendChild(tr);
        });

        container.appendChild(table);
      });
    }

    function renderFinali(finali) {
      const tbody = document.querySelector('#finaliTable tbody');
      tbody.innerHTML = '';
      finali
        .sort((a, b) => new Date(`${a.DATA} ${a.ORA}`) - new Date(`${b.DATA} ${b.ORA}`))
        .forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row.TURNO}</td>
            <td>${row.DATA}</td>
            <td>${row.ORA}</td>
            <td>${row.CAMPO}</td>
            <td>${row.SQUADRA1}</td>
            <td>${row.RISULTATO}</td>
            <td>${row.SQUADRA2}</td>
          `;
          tbody.appendChild(tr);
        });
    }

    async function init() {
      const data = await loadCSV(PROGRAMMA_URL);
      updateFilters(data);
      renderProgramma(data);
      const stats = calculateClassifiche(data);
      renderClassifiche(stats);

      const finali = await loadCSV(FINALI_URL);
      renderFinali(finali);

      document.querySelectorAll('select').forEach(sel => sel.addEventListener('change', () => {
        renderProgramma(data);
        renderClassifiche(stats);
      }));
    }

    init();
  </script>
</body>
</html>
