<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fase Finale Torneo</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    table {
      border-collapse: collapse;
      margin-bottom: 30px;
      width: 100%;
    }
    th, td {
      border: 1px solid #999;
      padding: 6px 10px;
      text-align: center;
    }
    th {
      background: #eee;
    }
    .vincente {
      background-color: #c6f6c3;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Fase Finale</h1>
  <div id="faseFinale"></div>

  <script>
    const gironiCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=1898554956&single=true&output=csv";
    const finaliCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=660358441&single=true&output=csv";

    async function caricaCSV(url) {
      const cachebuster = `&cachebuster=${new Date().getTime()}`;
      const response = await fetch(url + cachebuster);
      const text = await response.text();
      const [headerLine, ...lines] = text.trim().split("\n");
      const headers = headerLine.split(",");
      return lines.map(line => {
        const values = line.split(",");
        return Object.fromEntries(headers.map((h, i) => [h.trim(), values[i]?.trim()]));
      });
    }

    function calcolaClassifiche(partite) {
      const classifiche = {};
      partite.forEach(p => {
        const girone = p.GIRONE;
        if (!girone) return;
        if (!classifiche[girone]) classifiche[girone] = {};
        const c = classifiche[girone];
        [p.IDSQUADRA1, p.IDSQUADRA2].forEach(id => {
          if (!c[id]) c[id] = { punti: 0, gf: 0, gs: 0, nome: "", giocate: 0 };
        });
        const s1 = c[p.IDSQUADRA1], s2 = c[p.IDSQUADRA2];
        s1.nome = p.SQUADRA1;
        s2.nome = p.SQUADRA2;
        const [g1, g2] = p.RISULTATO.split("-").map(Number);
        if (!isNaN(g1) && !isNaN(g2)) {
          s1.gf += g1; s1.gs += g2; s1.giocate++;
          s2.gf += g2; s2.gs += g1; s2.giocate++;
          if (g1 > g2) s1.punti += 3;
          else if (g1 < g2) s2.punti += 3;
          else { s1.punti += 1; s2.punti += 1; }
        }
      });
      const posizioni = {};
      for (const girone in classifiche) {
        const squadre = Object.entries(classifiche[girone]).map(([id, dati]) => ({
          id, ...dati, diff: dati.gf - dati.gs
        }));
        squadre.sort((a, b) => b.punti - a.punti || b.diff - a.diff || b.gf - a.gf);
        posizioni[girone] = squadre;
      }
      return posizioni;
    }

    function getSquadraDaEtichetta(label, classifiche, terze, vincitori = {}) {
      const regex = /^(Prima|Seconda|Terza) classificata girone ([A-Z])$/;
      const terzeLabel = /^(.*)migliore terza classificata$/i;
      const vincenteTurno = /^Vincente (ottavo|quarto|semifinale) (\d+)$/i;

      const m = label.match(regex);
      if (m) {
        const posizione = { Prima: 0, Seconda: 1, Terza: 2 }[m[1]];
        return classifiche[m[2]]?.[posizione]?.nome || label;
      }
      const t = label.match(terzeLabel);
      if (t) {
        const posizione = t[1].toLowerCase().includes("seconda") ? 1 : 0;
        return terze[posizione]?.nome || label;
      }
      const v = label.match(vincenteTurno);
      if (v) {
        return vincitori[v[1].toLowerCase() + "_" + v[2]] || label;
      }
      return label;
    }

    function trovaVincente(ris, squadra1, squadra2) {
      const [g1, g2] = ris.split("-").map(Number);
      if (!isNaN(g1) && !isNaN(g2)) {
        if (g1 > g2) return squadra1;
        if (g2 > g1) return squadra2;
      }
      return "";
    }

    function renderFinali(datiFinali, classifiche) {
      const container = document.getElementById("faseFinale");
      container.innerHTML = "";
      const tutteTerze = Object.values(classifiche)
        .map(gr => gr[2])
        .filter(Boolean)
        .sort((a, b) => b.punti - a.punti || (b.gf - b.gs) - (a.gf - a.gs) || b.gf - a.gf);
      const miglioriTerze = tutteTerze.slice(0, 2);

      const vincitori = {};

      const perTurno = {};
      datiFinali.forEach(p => {
        if (!perTurno[p.TURNO]) perTurno[p.TURNO] = [];
        perTurno[p.TURNO].push(p);
      });

      const ordini = ["Ottavi di finale", "Quarti di finale", "Semifinali", "Finale", "Finalina"];
      ordini.forEach(turno => {
        const partite = perTurno[turno];
        if (!partite) return;
        const table = document.createElement("table");
        const caption = document.createElement("caption");
        caption.innerText = turno;
        caption.style.fontWeight = "bold";
        table.appendChild(caption);
        const thead = document.createElement("thead");
        thead.innerHTML = "<tr><th>Data</th><th>Ora</th><th>Campo</th><th>Squadra 1</th><th>Risultato</th><th>Squadra 2</th></tr>";
        table.appendChild(thead);
        const tbody = document.createElement("tbody");

        partite.forEach((p, i) => {
          const key = turno.toLowerCase().split(" ")[0] + "_" + (i + 1);
          p.s1 = getSquadraDaEtichetta(p.SQUADRA1, classifiche, miglioriTerze, vincitori);
          p.s2 = getSquadraDaEtichetta(p.SQUADRA2, classifiche, miglioriTerze, vincitori);
          p.vincente = trovaVincente(p.RISULTATO, p.s1, p.s2);
          if (p.vincente) vincitori[key] = p.vincente;

          const tr = document.createElement("tr");
          const td1 = document.createElement("td"); td1.innerText = p.DATA;
          const td2 = document.createElement("td"); td2.innerText = p.ORA;
          const td3 = document.createElement("td"); td3.innerText = p.CAMPO;
          const td4 = document.createElement("td"); td4.innerText = p.s1;
          if (p.vincente === p.s1) td4.classList.add("vincente");
          const td5 = document.createElement("td"); td5.innerText = p.RISULTATO;
          const td6 = document.createElement("td"); td6.innerText = p.s2;
          if (p.vincente === p.s2) td6.classList.add("vincente");
          [td1, td2, td3, td4, td5, td6].forEach(td => tr.appendChild(td));
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        container.appendChild(table);
      });
    }

    async function init() {
      const gironi = await caricaCSV(gironiCSV);
      const classifiche = calcolaClassifiche(gironi);
      const finali = await caricaCSV(finaliCSV);
      renderFinali(finali, classifiche);
    }

    init();
  </script>
</body>
</html>
