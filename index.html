<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Torneo LUI&LEI</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
    }
    h2 {
      margin-top: 40px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      background: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #e9e9e9;
    }
    tr.highlight {
      background-color: #d1ffd1;
      font-weight: bold;
    }
    .filters {
      margin-bottom: 20px;
    }
    .filters select {
      margin-right: 10px;
      padding: 5px;
    }
  </style>
</head>
<body>
  <h1>Torneo LUI&LEI - Programma e Risultati</h1>
  <div class="filters">
    <label for="filtroCampo">Campo:</label>
    <select id="filtroCampo"></select>
    <label for="filtroGiorno">Giorno:</label>
    <select id="filtroGiorno"></select>
    <label for="filtroGirone">Girone:</label>
    <select id="filtroGirone"></select>
  </div>

  <h2>Partite fase a gironi</h2>
  <table id="tabellaProgramma"></table>

  <h2>Classifiche</h2>
  <div id="classifiche"></div>

  <h2>Fase Finale</h2>
  <table id="faseFinale"></table>

  <script>
    const urlGironi = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=1898554956&single=true&output=csv";
    const urlFinali = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=660358441&single=true&output=csv";

    async function caricaCSV(url) {
      const response = await fetch(url);
      const text = await response.text();
      const rows = text.trim().split('\n').map(r => r.split(','));
      const headers = rows[0];
      const data = rows.slice(1).map(row => Object.fromEntries(headers.map((h, i) => [h.trim(), row[i] ? row[i].trim() : ""])));
      return data;
    }

    function aggiornaFiltri(data) {
      const campoSel = document.getElementById("filtroCampo");
      const giornoSel = document.getElementById("filtroGiorno");
      const gironeSel = document.getElementById("filtroGirone");
      const campi = [...new Set(data.map(d => d.CAMPO))];
      const giorni = [...new Set(data.map(d => d.GIORNO))];
      const gironi = [...new Set(data.map(d => d.GIRONE))];
      for (const val of ["", ...campi]) campoSel.innerHTML += `<option value="${val}">${val || "Tutti"}</option>`;
      for (const val of ["", ...giorni]) giornoSel.innerHTML += `<option value="${val}">${val || "Tutti"}</option>`;
      for (const val of ["", ...gironi]) gironeSel.innerHTML += `<option value="${val}">${val || "Tutti"}</option>`;
    }

    function mostraProgramma(data) {
      const campo = document.getElementById("filtroCampo").value;
      const giorno = document.getElementById("filtroGiorno").value;
      const girone = document.getElementById("filtroGirone").value;
      const filtrate = data.filter(r => (!campo || r.CAMPO === campo) && (!giorno || r.GIORNO === giorno) && (!girone || r.GIRONE === girone));
      filtrate.sort((a,b) => new Date(`${a.DATA}T${a.ORA}`) - new Date(`${b.DATA}T${b.ORA}`));
      const table = document.getElementById("tabellaProgramma");
      table.innerHTML = `<tr><th>Giorno</th><th>Ora</th><th>Campo</th><th>Girone</th><th>Squadra 1</th><th>Squadra 2</th><th>Risultato</th></tr>` +
        filtrate.map(r => `<tr><td>${r.GIORNO}</td><td>${r.ORA}</td><td>${r.CAMPO}</td><td>${r.GIRONE}</td><td>${r.SQUADRA1}</td><td>${r.SQUADRA2}</td><td>${r.RISULTATO}</td></tr>`).join('');
    }

    function calcolaClassifiche(data) {
      const gironi = [...new Set(data.map(r => r.GIRONE))];
      const classifiche = {};
      for (const girone of gironi) {
        classifiche[girone] = {};
        data.filter(r => r.GIRONE === girone).forEach(r => {
          const [g1, g2] = r.RISULTATO.split("-").map(n => parseInt(n));
          if (isNaN(g1) || isNaN(g2)) return;
          for (let i of [1, 2]) {
            const nome = r[`SQUADRA${i}`];
            if (!classifiche[girone][nome]) classifiche[girone][nome] = {PG: 0, V: 0, P: 0, S: 0, GF: 0, GS: 0, PT: 0};
          }
          classifiche[girone][r.SQUADRA1].PG++;
          classifiche[girone][r.SQUADRA2].PG++;
          classifiche[girone][r.SQUADRA1].GF += g1;
          classifiche[girone][r.SQUADRA1].GS += g2;
          classifiche[girone][r.SQUADRA2].GF += g2;
          classifiche[girone][r.SQUADRA2].GS += g1;
          if (g1 > g2) { classifiche[girone][r.SQUADRA1].V++; classifiche[girone][r.SQUADRA2].S++; classifiche[girone][r.SQUADRA1].PT += 3; }
          else if (g1 < g2) { classifiche[girone][r.SQUADRA2].V++; classifiche[girone][r.SQUADRA1].S++; classifiche[girone][r.SQUADRA2].PT += 3; }
          else { classifiche[girone][r.SQUADRA1].P++; classifiche[girone][r.SQUADRA2].P++; classifiche[girone][r.SQUADRA1].PT += 1; classifiche[girone][r.SQUADRA2].PT += 1; }
        });
      }
      const div = document.getElementById("classifiche");
      div.innerHTML = "";
      for (const girone in classifiche) {
        const squadre = Object.entries(classifiche[girone]);
        squadre.sort((a, b) => b[1].PT - a[1].PT || (b[1].GF - b[1].GS) - (a[1].GF - a[1].GS));
        const rows = squadre.map(([nome, stat], i) =>
          `<tr class='${i<2 ? "highlight" : ""}'><td>${nome}</td><td>${stat.PG}</td><td>${stat.V}</td><td>${stat.P}</td><td>${stat.S}</td><td>${stat.GF}</td><td>${stat.GS}</td><td>${stat.PT}</td></tr>`);
        div.innerHTML += `<h3>Girone ${girone}</h3><table><tr><th>Squadra</th><th>PG</th><th>V</th><th>P</th><th>S</th><th>GF</th><th>GS</th><th>PT</th></tr>${rows.join('')}</table>`;
      }
    }

    function mostraFinali(data) {
      const table = document.getElementById("faseFinale");
      table.innerHTML = `<tr><th>Turno</th><th>Squadra 1</th><th>Risultato</th><th>Squadra 2</th><th>Vincente</th></tr>` +
        data.map(r => `<tr><td>${r.TURNO}</td><td>${r.SQUADRA1}</td><td>${r.RISULTATO}</td><td>${r.SQUADRA2}</td><td>${r.VINCENTE}</td></tr>`).join('');
    }

    async function init() {
      const gironiData = await caricaCSV(urlGironi);
      const finaliData = await caricaCSV(urlFinali);
      aggiornaFiltri(gironiData);
      document.querySelectorAll(".filters select").forEach(sel => sel.addEventListener("change", () => mostraProgramma(gironiData)));
      mostraProgramma(gironiData);
      calcolaClassifiche(gironiData);
      mostraFinali(finaliData);
    }
    init();
  </script>
</body>
</html>
