<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mini-Torneo LUI&LEI 2025</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 1em; background: #f8f8f8; }
    h1, h2, h3 { color: #222; }
    .container { max-width: 1200px; margin: auto; }
    table { width: 100%; border-collapse: collapse; margin: 1em 0; background: white; }
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: center; }
    th { background: #eee; }
    .highlight { background-color: #d4edda; font-weight: bold; }
    .third-highlight { background-color: #ffeeba; font-weight: bold; }
    .filter { margin: 1em 0; }
    @media screen and (max-width: 768px) {
      table, thead, tbody, th, td, tr { display: block; }
      th { position: absolute; top: -9999px; left: -9999px; }
      td { border: none; position: relative; padding-left: 50%; }
      td:before { position: absolute; top: 0; left: 6px; white-space: nowrap; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Mini-Torneo LUI&LEI 2025 01</h1>

    <div class="filter">
      <label for="faseFilter">Visualizza:</label>
      <select id="faseFilter" onchange="filterFase()">
        <option value="tutto">Tutto</option>
        <option value="finali">Fase Finale</option>
      </select>
    </div>

    <div class="filter">
      <label for="gironeFilter">Filtra per girone:</label>
      <select id="gironeFilter" onchange="filterGirone()">
        <option value="">Tutti</option>
        <option value="A">Girone A</option>
        <option value="B">Girone B</option>
        <option value="C">Girone C</option>
        <option value="D">Girone D</option>
        <option value="E">Girone E</option>
        <option value="F">Girone F</option>
        <option value="G">Girone G</option>
      </select>
    </div>

    <h2>Programma Fase a Gironi</h2>
    <div id="programma"></div>

    <h2>Classifiche Gironi</h2>
    <div id="classifiche"></div>

    <h2>Migliori Terze Classificate</h2>
    <div id="terze"></div>

    <h2>Fase Finale</h2>
    <div id="finali"></div>
  </div>

  <script>
    const programmaUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=1898554956&single=true&output=csv";
    const finaliUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=660358441&single=true&output=csv";

    let gironiData = [];
    let classifiche = {};
    let finaliData = [];

    function caricaDati() {
      Papa.parse(programmaUrl, {
        download: true,
        header: true,
        complete: function(results) {
          gironiData = results.data.filter(r => r["GIRONE"]);
          mostraProgramma();
          calcolaClassifiche();
        }
      });
      Papa.parse(finaliUrl, {
        download: true,
        header: true,
        complete: function(results) {
          finaliData = results.data;
          mostraFinali();
        }
      });
    }

    function mostraProgramma() {
      const filtro = document.getElementById("gironeFilter").value;
      let html = `<table><thead><tr><th>Giorno</th><th>Data</th><th>Ora</th><th>Campo</th><th>Girone</th><th>Squadra 1</th><th>Risultato</th><th>Squadra 2</th></tr></thead><tbody>`;
      gironiData.filter(p => !filtro || p["GIRONE"] === filtro)
        .sort((a, b) => new Date(`${a["DATA"]}T${a["ORA"]}`) - new Date(`${b["DATA"]}T${b["ORA"]}`))
        .forEach(p => {
          html += `<tr><td>${p["GIORNO"]}</td><td>${p["DATA"]}</td><td>${p["ORA"]}</td><td>${p["CAMPO"]}</td><td>${p["GIRONE"]}</td><td>${p["SQUADRA1"]}</td><td>${p["RISULTATO"]}</td><td>${p["SQUADRA2"]}</td></tr>`;
        });
      html += `</tbody></table>`;
      document.getElementById("programma").innerHTML = html;
    }
	
    function calcolaClassifiche() {
      classifiche = {};
      gironiData.forEach(p => {
        const girone = p.GIRONE;
        if (!classifiche[girone]) classifiche[girone] = {};

        const [g1, g2] = p.RISULTATO.split("-").map(n => parseInt(n));
        const s1 = p.SQUADRA1;
        const s2 = p.SQUADRA2;

        [s1, s2].forEach(s => {
          if (!classifiche[girone][s]) classifiche[girone][s] = { PG: 0, GF: 0, GS: 0, P: 0 };
        });

        classifiche[girone][s1].PG++;
        classifiche[girone][s2].PG++;
        classifiche[girone][s1].GF += g1;
        classifiche[girone][s1].GS += g2;
        classifiche[girone][s2].GF += g2;
        classifiche[girone][s2].GS += g1;

        if (g1 > g2) classifiche[girone][s1].P += 3;
        else if (g2 > g1) classifiche[girone][s2].P += 3;
        else { classifiche[girone][s1].P += 1; classifiche[girone][s2].P += 1; }
      });
      mostraClassifiche();
      mostraTerze();
    }

    function mostraClassifiche() {
      const filtro = document.getElementById("gironeFilter").value;
      const gironiOrdinati = Object.keys(classifiche).sort();
      let html = "";
      let miglioriTerze = [];
      gironiOrdinati.forEach(g => {
        let squadre = Object.entries(classifiche[g]).map(([nome, stats]) => {
          const DR = stats.GF - stats.GS;
          return { nome, girone: g, ...stats, DR };
        });
        squadre.sort((a, b) => b.P - a.P || b.DR - a.DR || b.GF - a.GF);
        if (squadre.length >= 3) miglioriTerze.push(squadre[2]);
      });
      miglioriTerze.sort((a, b) => b.P - a.P || b.DR - a.DR || b.GF - a.GF);
      const primeDueTerze = miglioriTerze.slice(0, 2).map(s => s.nome);

      gironiOrdinati.forEach(g => {
        if (filtro && filtro !== g) return;
        let squadre = Object.entries(classifiche[g]).map(([nome, stats]) => {
          const DR = stats.GF - stats.GS;
          return { nome, girone: g, ...stats, DR };
        });
        squadre.sort((a, b) => b.P - a.P || b.DR - a.DR || b.GF - a.GF);
        html += `<h3>Girone ${g}</h3><table><thead><tr><th>Pos</th><th>Squadra</th><th>Punti</th><th>PG</th><th>GF</th><th>GS</th><th>DR</th></tr></thead><tbody>`;
        squadre.forEach((s, i) => {
          let cls = "";
          if (i < 2) cls = "highlight";
          else if (i === 2 && primeDueTerze.includes(s.nome)) cls = "third-highlight";
          html += `<tr class="${cls}"><td>${i + 1}</td><td>${s.nome}</td><td>${s.P}</td><td>${s.PG}</td><td>${s.GF}</td><td>${s.GS}</td><td>${s.DR}</td></tr>`;
        });
        html += `</tbody></table>`;
      });
      document.getElementById("classifiche").innerHTML = html;
    }

    function mostraTerze() {
      let terze = [];
      Object.keys(classifiche).forEach(g => {
        const squadre = Object.entries(classifiche[g]).map(([nome, stats]) => {
          const DR = stats.GF - stats.GS;
          return { girone: g, nome, ...stats, DR };
        });
        squadre.sort((a, b) => b.P - a.P || b.DR - a.DR || b.GF - a.GF);
        if (squadre.length >= 3) terze.push(squadre[2]);
      });
      terze.sort((a, b) => b.P - a.P || b.DR - a.DR || b.GF - a.GF);
      let html = `<table><thead><tr><th>Pos</th><th>Squadra</th><th>Girone</th><th>Punti</th><th>PG</th><th>GF</th><th>GS</th><th>DR</th></tr></thead><tbody>`;
      terze.forEach((t, i) => {
        const cls = i < 2 ? "third-highlight" : "";
        html += `<tr class="${cls}"><td>${i + 1}</td><td>${t.nome}</td><td>${t.girone}</td><td>${t.P}</td><td>${t.PG}</td><td>${t.GF}</td><td>${t.GS}</td><td>${t.DR}</td></tr>`;
      });
      html += `</tbody></table>`;
      document.getElementById("terze").innerHTML = html;
    }

    function mostraFinali() {
      let html = `<table><thead><tr>
        <th>Fase Finale</th><th>Data</th><th>Ora</th><th>Campo</th><th>Turno</th>
        <th>Squadra 1</th><th>Risultato</th><th>Squadra 2</th>
      </tr></thead><tbody>`;

      finaliData.sort((a, b) => new Date(`${a.DATA}T${a.ORA}`) - new Date(`${b.DATA}T${b.ORA}`))
        .forEach(f => {
          html += `<tr>
            <td>${f["FASE FINALE"]}</td>
            <td>${f.DATA}</td>
            <td>${f.ORA}</td>
            <td>${f.CAMPO}</td>
            <td>${f.TURNO}</td>
            <td>${f.SQUADRA1}</td>
            <td>${f.RISULTATO}</td>
            <td>${f.SQUADRA2}</td>
          </tr>`;
        });

      html += `</tbody></table>`;
      document.getElementById("finali").innerHTML = html;
    }

    function filterFase() {
      const value = document.getElementById("faseFilter").value;
      document.getElementById("contenutoGironi").style.display = value === "finali" ? "none" : "block";
      document.getElementById("gironeFilter").disabled = value === "finali";
    }


    function filterGirone() {
      const filtro = document.getElementById("gironeFilter").value;
      mostraProgramma();
      mostraClassifiche();

      // Mostra/nasconde sezione "Migliori Terze" e "Fase Finale"
      document.getElementById("terze").style.display = filtro ? "none" : "block";
      document.getElementById("finali").style.display = filtro ? "none" : "block";

      // Nasconde anche i titoli sezione
      document.querySelector("h2:nth-of-type(3)").style.display = filtro ? "none" : "block";
      document.querySelector("h2:nth-of-type(4)").style.display = filtro ? "none" : "block";
    }

    window.onload = caricaDati;
  </script>
</body>
</html>
