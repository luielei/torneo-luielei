<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Torneo LUI&LEI - Programma e Finali</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f4f6f8;
      color: #333;
      margin: 0;
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
      color: #1a73e8;
    }
    .filters, .table-container {
      max-width: 1000px;
      margin: 20px auto;
    }
    .filters select {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #e3f2fd;
    }
    .highlight {
      background-color: #c8e6c9;
    }
    .winner {
      font-weight: bold;
      color: green;
    }
  </style>
</head>
<body>
  <h1>Torneo LUI&LEI</h1>
  <h2>Programma e Classifiche</h2>
  <div class="filters">
    <label for="campoFilter">Campo:</label>
    <select id="campoFilter">
      <option value="">Tutti</option>
    </select>

    <label for="giornoFilter">Giorno:</label>
    <select id="giornoFilter">
      <option value="">Tutti</option>
    </select>

    <label for="gironeFilter">Girone:</label>
    <select id="gironeFilter">
      <option value="">Tutti</option>
    </select>
  </div>

  <div class="table-container">
    <table id="programmaTable">
      <thead>
        <tr>
          <th>Giorno</th><th>Data</th><th>Ora</th><th>Campo</th><th>Girone</th>
          <th>Squadra 1</th><th>Squadra 2</th><th>Risultato</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <h2>Classifiche</h2>
  <div class="table-container">
    <table id="classificheTable">
      <thead>
        <tr>
          <th>Girone</th><th>Squadra</th><th>PG</th><th>V</th><th>N</th><th>P</th><th>GF</th><th>GS</th><th>DR</th><th>Pt</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <h2>Fase Finale</h2>
  <div class="table-container">
    <table id="finaliTable">
      <thead>
        <tr>
          <th>Giorno</th><th>Data</th><th>Ora</th><th>Campo</th><th>Turno</th>
          <th>Squadra 1</th><th>Squadra 2</th><th>Risultato</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const programmaCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=1898554956&single=true&output=csv';
    const finaliCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=660358441&single=true&output=csv';

    async function fetchCSV(url) {
      const response = await fetch(url);
      const text = await response.text();
      const rows = text.trim().split('\n').map(r => r.split(','));
      const headers = rows[0];
      return rows.slice(1).map(row => Object.fromEntries(row.map((cell, i) => [headers[i], cell])));
    }

    function updateFilters(programma) {
      const campoSet = new Set(), giornoSet = new Set(), gironeSet = new Set();
      programma.forEach(p => {
        campoSet.add(p.CAMPO);
        giornoSet.add(p.GIORNO);
        gironeSet.add(p.GIRONE);
      });
      const populate = (id, set) => {
        const sel = document.getElementById(id);
        set.forEach(val => {
          const opt = document.createElement('option');
          opt.value = val;
          opt.textContent = val;
          sel.appendChild(opt);
        });
      };
      populate('campoFilter', campoSet);
      populate('giornoFilter', giornoSet);
      populate('gironeFilter', gironeSet);
    }

    function filterAndRender(programma) {
      const campo = document.getElementById('campoFilter').value;
      const giorno = document.getElementById('giornoFilter').value;
      const girone = document.getElementById('gironeFilter').value;

      const filtered = programma.filter(p =>
        (!campo || p.CAMPO === campo) &&
        (!giorno || p.GIORNO === giorno) &&
        (!girone || p.GIRONE === girone)
      );

      const tbody = document.querySelector('#programmaTable tbody');
      tbody.innerHTML = '';
      filtered.sort((a,b) => (a.DATA + a.ORA).localeCompare(b.DATA + b.ORA)).forEach(p => {
        const tr = document.createElement('tr');
        [p.GIORNO, p.DATA, p.ORA, p.CAMPO, p.GIRONE, p.SQUADRA1, p.SQUADRA2, p.RISULTATO].forEach(text => {
          const td = document.createElement('td');
          td.textContent = text;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    function renderClassifiche(programma) {
      const stats = {};
      programma.forEach(p => {
        const g = p.GIRONE;
        const s1 = p.SQUADRA1, s2 = p.SQUADRA2;
        if (!s1 || !s2 || !p.RISULTATO.includes('-')) return;
        const [g1, g2] = p.RISULTATO.split('-').map(Number);
        if (!stats[g]) stats[g] = {};
        const init = team => stats[g][team] = stats[g][team] || { PG:0, V:0, N:0, P:0, GF:0, GS:0, Pt:0 };
        init(s1); init(s2);
        stats[g][s1].PG++; stats[g][s1].GF += g1; stats[g][s1].GS += g2;
        stats[g][s2].PG++; stats[g][s2].GF += g2; stats[g][s2].GS += g1;
        if (g1 > g2) { stats[g][s1].V++; stats[g][s2].P++; stats[g][s1].Pt += 3; }
        else if (g1 < g2) { stats[g][s2].V++; stats[g][s1].P++; stats[g][s2].Pt += 3; }
        else { stats[g][s1].N++; stats[g][s2].N++; stats[g][s1].Pt++; stats[g][s2].Pt++; }
      });
      const tbody = document.querySelector('#classificheTable tbody');
      tbody.innerHTML = '';
      Object.entries(stats).forEach(([g, squadre]) => {
        const sorted = Object.entries(squadre).sort((a,b) => b[1].Pt - a[1].Pt || (b[1].GF - b[1].GS) - (a[1].GF - a[1].GS));
        sorted.forEach(([s, v], i) => {
          const tr = document.createElement('tr');
          if (i < 2) tr.classList.add('highlight');
          const DR = v.GF - v.GS;
          [g, s, v.PG, v.V, v.N, v.P, v.GF, v.GS, DR, v.Pt].forEach(t => {
            const td = document.createElement('td');
            td.textContent = t;
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      });
    }

    function renderFinali(fase) {
      const tbody = document.querySelector('#finaliTable tbody');
      tbody.innerHTML = '';
      fase.forEach(p => {
        const tr = document.createElement('tr');
        [p.GIORNO, p.DATA, p.ORA, p.CAMPO, p.TURNO, p.SQUADRA1, p.SQUADRA2, p.RISULTATO].forEach(text => {
          const td = document.createElement('td');
          td.textContent = text;
          if (text === p.RISULTATO) {
            const [g1, g2] = p.RISULTATO.split('-').map(Number);
            if (!isNaN(g1) && !isNaN(g2)) {
              if (g1 > g2) tr.children[5].classList.add('winner');
              else if (g2 > g1) tr.children[6].classList.add('winner');
            }
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    async function init() {
      const programma = await fetchCSV(programmaCSV);
      updateFilters(programma);
      filterAndRender(programma);
      renderClassifiche(programma);
      const faseFinale = await fetchCSV(finaliCSV);
      renderFinali(faseFinale);
    }

    document.getElementById('campoFilter').addEventListener('change', () => init());
    document.getElementById('giornoFilter').addEventListener('change', () => init());
    document.getElementById('gironeFilter').addEventListener('change', () => init());

    init();
  </script>
</body>
</html>
