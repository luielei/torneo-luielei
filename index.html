<!-- L'HTML è troppo lungo per stare tutto qui in un unico messaggio. Ti invio subito la seconda parte. -->
  const finaliUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=660358441&single=true&output=csv&cachebuster=" + new Date().getTime();

  function renderFaseFinale(partiteFinali, classifiche) {
    const container = document.createElement("div");
    container.innerHTML = "<h2 class='section-title'>Fase Finale</h2>";
    const turni = ["Ottavi", "Quarti", "Semifinali", "Finale", "Finale 3° Posto"];

    const vincitori = {};

    turni.forEach(turno => {
      const partiteTurno = partiteFinali
        .filter(p => p.TURNO === turno)
        .sort((a, b) => new Date(`${a.DATA}T${a.ORA}`) - new Date(`${b.DATA}T${b.ORA}`));

      if (partiteTurno.length === 0) return;

      const table = document.createElement("table");
      const caption = document.createElement("caption");
      caption.className = "section-title";
      caption.textContent = `Partite ${turno}`;
      table.appendChild(caption);

      const thead = document.createElement("thead");
      thead.innerHTML = `<tr><th>Giorno</th><th>Ora</th><th>Campo</th><th>Squadra 1</th><th>Risultato</th><th>Squadra 2</th></tr>`;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      partiteTurno.forEach(p => {
        const squadra1 = sostituisciSegnaposto(p.SQUADRA1, classifiche);
        const squadra2 = sostituisciSegnaposto(p.SQUADRA2, classifiche);

        const [gol1, gol2] = p.RISULTATO.includes("-") ? p.RISULTATO.split("-").map(n => parseInt(n)) : [null, null];

        let row = document.createElement("tr");
        row.innerHTML = `<td>${p.GIORNO}</td><td>${p.ORA}</td><td>${p.CAMPO}</td><td>${squadra1}</td><td>${p.RISULTATO}</td><td>${squadra2}</td>`;

        // Evidenzia la vincente se c'è un risultato
        if (gol1 !== null && gol2 !== null) {
          const vincente = gol1 > gol2 ? squadra1 : gol2 > gol1 ? squadra2 : null;
          if (vincente) {
            row.querySelectorAll("td")[3 + (vincente === squadra2 ? 2 : 0)].classList.add("highlight");
            vincitori[`${turno}-${p.ID}`] = vincente;
          }
        }

        tbody.appendChild(row);
      });

      table.appendChild(tbody);
      container.appendChild(table);
    });

    document.body.appendChild(container);
  }

  function sostituisciSegnaposto(nome, classifiche) {
    if (!nome) return "";

    if (!nome.includes("girone")) return nome;

    const match = nome.match(/(Prima|Seconda|Terza|Migliore Terza) classificata(?: (?:del|girone) )?([A-Z])?/i);
    if (!match) return nome;

    const posizione = match[1].toLowerCase();
    const girone = match[2];

    if (posizione === "migliore terza") {
      return miglioriTerze[0]?.squadra || nome;
    }

    if (posizione === "seconda migliore terza") {
      return miglioriTerze[1]?.squadra || nome;
    }

    const squadre = classifiche[girone];
    if (!squadre) return nome;

    const ordinata = Object.values(squadre).sort((a, b) => b.punti - a.punti || b.diff - a.diff || b.gf - a.gf);

    switch (posizione) {
      case "prima": return ordinata[0]?.squadra || nome;
      case "seconda": return ordinata[1]?.squadra || nome;
      case "terza": return ordinata[2]?.squadra || nome;
      default: return nome;
    }
  }

  async function caricaFaseFinale(classifiche) {
    const res = await fetch(finaliUrl);
    const text = await res.text();
    const partiteFinali = parseCSV(text);
    renderFaseFinale(partiteFinali, classifiche);
  }

  // Estendi la init con caricamento fase finale
  async function init() {
    const response = await fetch(csvUrl);
    const text = await response.text();
    const partite = parseCSV(text);

    aggiornaFiltri(partite);
    const classifiche = calcolaClassifiche(partite);
    trovaTerze(classifiche);
    renderProgramma(partite, {});
    renderClassifiche(classifiche, null);
    renderMiglioriTerze();
    await caricaFaseFinale(classifiche); // <-- Fase finale!

    document.getElementById("campoFilter").addEventListener("change", () => renderProgramma(partite, {
      campo: campoFilter.value,
      giorno: giornoFilter.value,
      girone: gironeFilter.value
    }));

    document.getElementById("giornoFilter").addEventListener("change", () => renderProgramma(partite, {
      campo: campoFilter.value,
      giorno: giornoFilter.value,
      girone: gironeFilter.value
    }));

    document.getElementById("gironeFilter").addEventListener("change", () => {
      const girone = gironeFilter.value;
      renderProgramma(partite, {
        campo: campoFilter.value,
        giorno: giornoFilter.value,
        girone: girone
      });
      renderClassifiche(classifiche, girone);
      document.getElementById("miglioriTerzeContainer").style.display = girone ? "none" : "block";
    });
  }

  init();
</script>
</body>
</html>
