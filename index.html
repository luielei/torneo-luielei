<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LUI&LEI - Torneo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 1rem;
      background: #f9f9f9;
    }
    h2 {
      color: #2e3b4e;
      border-bottom: 2px solid #ccc;
      padding-bottom: 5px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 2rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: center;
    }
    th {
      background-color: #4CAF50;
      color: white;
    }
    tr.highlight {
      background-color: #c8e6c9 !important;
    }
    tr.highlight-3rd {
      background-color: #e0f2f1;
    }
    label {
      font-weight: bold;
    }
    select {
      margin: 0 10px 20px 0;
      padding: 4px;
    }
  </style>
</head>
<body>

  <h2>Filtri</h2>
  <label for="campoSelect">Campo:</label>
  <select id="campoSelect" onchange="renderAll()">
    <option value="">Tutti</option>
  </select>

  <label for="giornoSelect">Giorno:</label>
  <select id="giornoSelect" onchange="renderAll()">
    <option value="">Tutti</option>
  </select>

  <label for="gironeSelect">Girone:</label>
  <select id="gironeSelect" onchange="renderAll()">
    <option value="">Tutti</option>
  </select>

  <h2>Programma Partite</h2>
  <div id="programma"></div>

  <h2>Classifiche Gironi</h2>
  <div id="classifiche"></div>

  <h2>Classifica Terze Classificate</h2>
  <div id="terzeClassificate"></div>

  <script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=1898554956&single=true&output=csv";
    let partite = [];

    function parseRisultato(ris) {
      if (!ris || !ris.includes("-")) return [0, 0];
      const [g1, g2] = ris.split("-").map(n => parseInt(n));
      return [isNaN(g1) ? 0 : g1, isNaN(g2) ? 0 : g2];
    }

    function loadCSV(url, callback) {
      fetch(url + '&cachebuster=' + new Date().getTime())
        .then(res => res.text())
        .then(text => {
          const rows = text.trim().split("\n").map(r => r.split(","));
          const headers = rows.shift();
          const data = rows.map(r => {
            const obj = {};
            headers.forEach((h, i) => obj[h.trim()] = r[i]?.trim());
            return obj;
          });
          callback(data);
        });
    }

    function renderProgramma() {
      const campo = document.getElementById("campoSelect").value;
      const giorno = document.getElementById("giornoSelect").value;
      const girone = document.getElementById("gironeSelect").value;

      const filtered = partite
        .filter(p => (!campo || p.CAMPO === campo) &&
                     (!giorno || p.GIORNO === giorno) &&
                     (!girone || p.GIRONE === girone))
        .sort((a, b) => new Date(`${a.DATA} ${a.ORA}`) - new Date(`${b.DATA} ${b.ORA}`));

      let html = "<table><tr><th>Giorno</th><th>Data</th><th>Ora</th><th>Campo</th><th>Girone</th><th>Squadra 1</th><th>Risultato</th><th>Squadra 2</th></tr>";
      filtered.forEach(p => {
        html += `<tr><td>${p.GIORNO}</td><td>${p.DATA}</td><td>${p.ORA}</td><td>${p.CAMPO}</td><td>${p.GIRONE}</td><td>${p.SQUADRA1}</td><td>${p.RISULTATO}</td><td>${p.SQUADRA2}</td></tr>`;
      });
      html += "</table>";
      document.getElementById("programma").innerHTML = html;
    }

    function renderClassifiche() {
      const girone = document.getElementById("gironeSelect").value;
      const gironi = {};

      partite.forEach(p => {
        if (!p.GIRONE) return;
        if (!gironi[p.GIRONE]) gironi[p.GIRONE] = {};
        const g = gironi[p.GIRONE];
        g[p.SQUADRA1] ??= { squadra: p.SQUADRA1, punti: 0, gf: 0, gs: 0, vinte: 0, pari: 0, perse: 0, giocate: 0 };
        g[p.SQUADRA2] ??= { squadra: p.SQUADRA2, punti: 0, gf: 0, gs: 0, vinte: 0, pari: 0, perse: 0, giocate: 0 };

        const [g1, g2] = parseRisultato(p.RISULTATO);
        g[p.SQUADRA1].gf += g1;
        g[p.SQUADRA1].gs += g2;
        g[p.SQUADRA2].gf += g2;
        g[p.SQUADRA2].gs += g1;
        g[p.SQUADRA1].giocate++;
        g[p.SQUADRA2].giocate++;

        if (g1 > g2) {
          g[p.SQUADRA1].punti += 3;
          g[p.SQUADRA1].vinte++;
          g[p.SQUADRA2].perse++;
        } else if (g2 > g1) {
          g[p.SQUADRA2].punti += 3;
          g[p.SQUADRA2].vinte++;
          g[p.SQUADRA1].perse++;
        } else {
          g[p.SQUADRA1].punti += 1;
          g[p.SQUADRA2].punti += 1;
          g[p.SQUADRA1].pari++;
          g[p.SQUADRA2].pari++;
        }
      });

      let html = "";
      const terze = [];

      Object.keys(gironi).sort().forEach(g => {
        if (girone && girone !== g) return;
        const squadre = Object.values(gironi[g]);
        squadre.sort((a, b) => b.punti - a.punti || (b.gf - b.gs) - (a.gf - a.gs) || b.gf - a.gf);
        html += `<h3>Girone ${g}</h3><table><tr><th>Squadra</th><th>PG</th><th>V</th><th>P</th><th>S</th><th>GF</th><th>GS</th><th>DR</th><th>Punti</th></tr>`;
        squadre.forEach((s, idx) => {
          let cls = "";
          if (idx === 0 || idx === 1) cls = "highlight";
          else if (idx === 2) terze.push({ girone: g, ...s });

          html += `<tr class="${cls}"><td>${s.squadra}</td><td>${s.giocate}</td><td>${s.vinte}</td><td>${s.pari}</td><td>${s.perse}</td><td>${s.gf}</td><td>${s.gs}</td><td>${s.gf - s.gs}</td><td>${s.punti}</td></tr>`;
        });
        html += "</table>";
      });

      if (!girone) {
        terze.sort((a, b) => b.punti - a.punti || (b.gf - b.gs) - (a.gf - a.gs) || b.gf - a.gf);
        html += `<h3>Classifica Terze Classificate</h3><table><tr><th>Girone</th><th>Squadra</th><th>PG</th><th>V</th><th>P</th><th>S</th><th>GF</th><th>GS</th><th>DR</th><th>Punti</th></tr>`;
        terze.forEach((s, idx) => {
          const cls = idx < 2 ? "highlight-3rd" : "";
          html += `<tr class="${cls}"><td>${s.girone}</td><td>${s.squadra}</td><td>${s.giocate}</td><td>${s.vinte}</td><td>${s.pari}</td><td>${s.perse}</td><td>${s.gf}</td><td>${s.gs}</td><td>${s.gf - s.gs}</td><td>${s.punti}</td></tr>`;
        });
        html += "</table>";
      }

      document.getElementById("classifiche").innerHTML = html;
    }

    function renderAll() {
      renderProgramma();
      renderClassifiche();
    }

    function init() {
      loadCSV(SHEET_URL, data => {
        partite = data;
        const campi = [...new Set(data.map(p => p.CAMPO))].sort();
        const giorni = [...new Set(data.map(p => p.GIORNO))].sort();
        const gironi = [...new Set(data.map(p => p.GIRONE))].filter(g => g).sort();

        const setOptions = (id, values) => {
          const select = document.getElementById(id);
          values.forEach(v => {
            const opt = document.createElement("option");
            opt.value = v;
            opt.textContent = v;
            select.appendChild(opt);
          });
        };
        setOptions("campoSelect", campi);
        setOptions("giornoSelect", giorni);
        setOptions("gironeSelect", gironi);

        renderAll();
      });
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
