<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Fase Finale Torneo</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 40px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #f0f0f0;
    }
    caption {
      text-align: left;
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .vincente {
      background-color: #c8f7c5;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Fase Finale</h1>
  <div id="faseFinale"></div>

  <script>
    const gironiCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=1898554956&single=true&output=csv";
    const finaliCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=660358441&single=true&output=csv";

    async function caricaCSV(url) {
      const cachebuster = "&cachebuster=" + new Date().getTime();
      const res = await fetch(url + cachebuster);
      const text = await res.text();
      const [header, ...rows] = text.trim().split("\n");
      const headers = header.split(",");
      return rows.map(r => {
        const values = r.split(",");
        return Object.fromEntries(headers.map((h, i) => [h.trim(), values[i]?.trim()]));
      });
    }

    function calcolaClassifiche(partite) {
      const classifiche = {};
      partite.forEach(p => {
        const g = p.GIRONE;
        if (!g) return;
        classifiche[g] = classifiche[g] || {};
        [p.IDSQUADRA1, p.IDSQUADRA2].forEach(id => {
          if (!classifiche[g][id]) classifiche[g][id] = { nome: "", punti: 0, gf: 0, gs: 0, giocate: 0 };
        });
        const s1 = classifiche[g][p.IDSQUADRA1];
        const s2 = classifiche[g][p.IDSQUADRA2];
        s1.nome = p.SQUADRA1;
        s2.nome = p.SQUADRA2;
        const [g1, g2] = p.RISULTATO.split("-").map(Number);
        if (!isNaN(g1) && !isNaN(g2)) {
          s1.gf += g1; s1.gs += g2; s1.giocate++;
          s2.gf += g2; s2.gs += g1; s2.giocate++;
          if (g1 > g2) s1.punti += 3;
          else if (g1 < g2) s2.punti += 3;
          else { s1.punti += 1; s2.punti += 1; }
        }
      });
      const risultati = {};
      for (const g in classifiche) {
        const squadre = Object.entries(classifiche[g]).map(([id, dati]) => ({
          id, ...dati, diff: dati.gf - dati.gs
        }));
        squadre.sort((a, b) => b.punti - a.punti || b.diff - a.diff || b.gf - a.gf);
        risultati[g] = squadre;
      }
      return risultati;
    }

    function trovaVincente(ris, s1, s2) {
      const [g1, g2] = ris.split("-").map(Number);
      if (!isNaN(g1) && !isNaN(g2)) {
        return g1 > g2 ? s1 : g2 > g1 ? s2 : "";
      }
      return "";
    }

    function getNome(label, classifiche, terze, vincitori) {
      const matchGirone = label.match(/^(Prima|Seconda|Terza) classificata girone ([A-Z])$/);
      const matchTerze = label.match(/^(.*)migliore terza classificata$/i);
      const matchVincente = label.match(/^Vincente (ottavo|quarto|semifinale|finalina|finale) (\d+)/i);

      if (matchGirone) {
        const pos = { Prima: 0, Seconda: 1, Terza: 2 }[matchGirone[1]];
        const g = matchGirone[2];
        return classifiche[g]?.[pos]?.nome || label;
      }
      if (matchTerze) {
        const index = matchTerze[1].toLowerCase().includes("seconda") ? 1 : 0;
        return terze[index]?.nome || label;
      }
      if (matchVincente) {
        const key = `${matchVincente[1].toLowerCase()}_${matchVincente[2]}`;
        return vincitori[key] || label;
      }
      return label;
    }

    function renderFinali(partite, classifiche) {
      const div = document.getElementById("faseFinale");
      div.innerHTML = "";

      const tutteTerze = Object.values(classifiche).map(g => g[2]).filter(Boolean);
      tutteTerze.sort((a, b) => b.punti - a.punti || (b.gf - b.gs) - (a.gf - a.gs) || b.gf - a.gf);
      const miglioriTerze = tutteTerze.slice(0, 2);

      const vincitori = {};
      const ordineTurni = ["Ottavi di finale", "Quarti di finale", "Semifinali", "Finale", "Finalina"];
      const perTurno = {};

      for (const p of partite) {
        if (!perTurno[p.TURNO]) perTurno[p.TURNO] = [];
        perTurno[p.TURNO].push(p);
      }

      ordineTurni.forEach(turno => {
        const matches = perTurno[turno];
        if (!matches) return;
        const table = document.createElement("table");
        const caption = document.createElement("caption");
        caption.textContent = turno;
        table.appendChild(caption);
        table.innerHTML += `
          <thead><tr><th>Data</th><th>Ora</th><th>Campo</th><th>Squadra 1</th><th>Risultato</th><th>Squadra 2</th></tr></thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector("tbody");
        matches.forEach((p, idx) => {
          const squadra1 = getNome(p.SQUADRA1, classifiche, miglioriTerze, vincitori);
          const squadra2 = getNome(p.SQUADRA2, classifiche, miglioriTerze, vincitori);
          const vincente = trovaVincente(p.RISULTATO, squadra1, squadra2);
          const chiave = turno.toLowerCase().split(" ")[0] + "_" + (idx + 1);
          if (vincente) vincitori[chiave] = vincente;
          const riga = `
            <tr>
              <td>${p.DATA}</td>
              <td>${p.ORA}</td>
              <td>${p.CAMPO}</td>
              <td class="${vincente === squadra1 ? "vincente" : ""}">${squadra1}</td>
              <td>${p.RISULTATO}</td>
              <td class="${vincente === squadra2 ? "vincente" : ""}">${squadra2}</td>
            </tr>
          `;
          tbody.innerHTML += riga;
        });
        div.appendChild(table);
      });
    }

    async function init() {
      const gironi = await caricaCSV(gironiCSV);
      const finali = await caricaCSV(finaliCSV);
      const classifiche = calcolaClassifiche(gironi);
      renderFinali(finali, classifiche);
    }

    init();
  </script>
</body>
</html>
