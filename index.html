<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Fase a Gironi e Finali - Torneo LUI&LEI</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f8f8; padding: 20px; }
    h2 { margin-top: 40px; border-bottom: 2px solid #ccc; padding-bottom: 5px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 40px; background: white; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; font-size: 14px; }
    th { background: #eee; }
    .highlight { background-color: #c6f6c6; font-weight: bold; }
    .best-third { background-color: #e2f0cb; }
    .filter-container { margin: 20px 0; }
    .filter-container select { padding: 6px; font-size: 14px; margin-right: 10px; }
    .section-title { background-color: #ddd; padding: 10px; margin-top: 40px; font-size: 18px; font-weight: bold; }
  </style>
</head>
<body>

<h1>Torneo LUI&LEI - Fase a Gironi e Finali</h1>

<div class="filter-container">
  <label for="campoFilter">Campo:</label>
  <select id="campoFilter">
    <option value="">Tutti</option>
  </select>

  <label for="giornoFilter">Giorno:</label>
  <select id="giornoFilter">
    <option value="">Tutti</option>
  </select>

  <label for="gironeFilter">Girone:</label>
  <select id="gironeFilter">
    <option value="">Tutti</option>
  </select>
</div>

<div id="programmaContainer"></div>
<div id="classificheContainer"></div>
<div id="terzeClassificateContainer"></div>
<div id="faseFinaleContainer"></div>

<script>
  const PROGRAMMA_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=1898554956&single=true&output=csv";
  const FINALI_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=660358441&single=true&output=csv";

  let partite = [];
  let classifiche = {};
  let miglioriTerze = [];
  let gironi = new Set();

  async function init() {
    const programmaResponse = await fetch(PROGRAMMA_URL + '&cachebuster=' + Date.now());
    const programmaText = await programmaResponse.text();
    partite = parseCSV(programmaText);
    renderProgramma();
    calcolaClassifiche();
    renderClassifiche();
    renderMiglioriTerze();
    setupFiltri();

    const finaliResponse = await fetch(FINALI_URL + '&cachebuster=' + Date.now());
    const finaliText = await finaliResponse.text();
    const partiteFinali = parseCSV(finaliText);
    renderFaseFinale(partiteFinali);
  }

  function parseCSV(csv) {
    const [headerLine, ...lines] = csv.trim().split("\n");
    const headers = headerLine.split(",");
    return lines.map(line => {
      const values = line.split(",");
      const obj = {};
      headers.forEach((h, i) => obj[h.trim()] = values[i]?.trim());
      return obj;
    });
  }
  function renderProgramma() {
    const container = document.getElementById("programmaContainer");
    container.innerHTML = "<h2>Fase a Gironi - Programma</h2>";
    const table = document.createElement("table");
    const thead = table.createTHead();
    thead.innerHTML = "<tr><th>Giorno</th><th>Data</th><th>Ora</th><th>Campo</th><th>Girone</th><th>Squadra 1</th><th>Squadra 2</th><th>Risultato</th></tr>";
    const tbody = table.createTBody();

    partite
      .filter(p => p.GIRONE && p.GIRONE !== "")
      .sort((a, b) => new Date(`${a.DATA} ${a.ORA}`) - new Date(`${b.DATA} ${b.ORA}`))
      .forEach(p => {
        const tr = tbody.insertRow();
        tr.insertCell().textContent = p.GIORNO;
        tr.insertCell().textContent = p.DATA;
        tr.insertCell().textContent = p.ORA;
        tr.insertCell().textContent = p.CAMPO;
        tr.insertCell().textContent = p.GIRONE;
        tr.insertCell().textContent = p.SQUADRA1;
        tr.insertCell().textContent = p.SQUADRA2;
        tr.insertCell().textContent = p.RISULTATO;
        gironi.add(p.GIRONE);
      });

    container.appendChild(table);
  }

  function calcolaClassifiche() {
    classifiche = {};
    const punti = {};
    const differenzeReti = {};
    const golFatti = {};
    const partiteGiocate = {};

    partite.forEach(p => {
      const girone = p.GIRONE;
      if (!girone) return;
      classifiche[girone] ??= {};
      punti[girone] ??= {};
      differenzeReti[girone] ??= {};
      golFatti[girone] ??= {};
      partiteGiocate[girone] ??= {};

      const s1 = p.SQUADRA1, s2 = p.SQUADRA2;
      if (!s1 || !s2 || !p.RISULTATO.includes("-")) return;

      const [g1, g2] = p.RISULTATO.split("-").map(Number);

      [s1, s2].forEach(s => {
        classifiche[girone][s] ??= { punti: 0, gf: 0, gs: 0, partite: 0, vinte: 0, pari: 0, perse: 0 };
      });

      classifiche[girone][s1].gf += g1;
      classifiche[girone][s1].gs += g2;
      classifiche[girone][s1].partite++;
      classifiche[girone][s2].gf += g2;
      classifiche[girone][s2].gs += g1;
      classifiche[girone][s2].partite++;

      if (g1 > g2) { classifiche[girone][s1].punti += 3; classifiche[girone][s1].vinte++; classifiche[girone][s2].perse++; }
      else if (g1 < g2) { classifiche[girone][s2].punti += 3; classifiche[girone][s2].vinte++; classifiche[girone][s1].perse++; }
      else { classifiche[girone][s1].punti += 1; classifiche[girone][s2].punti += 1; classifiche[girone][s1].pari++; classifiche[girone][s2].pari++; }
    });

    // Calcola migliori terze
    const terze = [];
    Object.entries(classifiche).forEach(([girone, squadre]) => {
      const classifica = Object.entries(squadre).map(([squadra, stat]) => {
        return {
          squadra,
          girone,
          punti: stat.punti,
          diff: stat.gf - stat.gs,
          gf: stat.gf
        };
      }).sort((a, b) =>
        b.punti - a.punti || b.diff - a.diff || b.gf - a.gf
      );
      if (classifica[2]) terze.push(classifica[2]);
    });

    miglioriTerze = terze.sort((a, b) =>
      b.punti - a.punti || b.diff - a.diff || b.gf - a.gf
    );
  }

  function renderClassifiche() {
    const container = document.getElementById("classificheContainer");
    container.innerHTML = "<h2>Classifiche per Girone</h2>";

    Array.from(gironi).sort().forEach(girone => {
      const squadre = classifiche[girone];
      if (!squadre) return;

      const title = document.createElement("div");
      title.className = "section-title";
      title.textContent = "Girone " + girone;
      container.appendChild(title);

      const table = document.createElement("table");
      const thead = table.createTHead();
      thead.innerHTML = "<tr><th>Squadra</th><th>Pt</th><th>GF</th><th>GS</th><th>DR</th><th>G</th><th>V</th><th>N</th><th>P</th></tr>";
      const tbody = table.createTBody();

      const rows = Object.entries(squadre).map(([squadra, stat]) => {
        return {
          squadra,
          ...stat,
          dr: stat.gf - stat.gs
        };
      }).sort((a, b) =>
        b.punti - a.punti || b.dr - a.dr || b.gf - a.gf
      );

      rows.forEach((row, idx) => {
        const tr = tbody.insertRow();
        tr.insertCell().textContent = row.squadra;
        tr.insertCell().textContent = row.punti;
        tr.insertCell().textContent = row.gf;
        tr.insertCell().textContent = row.gs;
        tr.insertCell().textContent = row.dr;
        tr.insertCell().textContent = row.partite;
        tr.insertCell().textContent = row.vinte;
        tr.insertCell().textContent = row.pari;
        tr.insertCell().textContent = row.perse;

        if (idx < 2) tr.classList.add("highlight");
        if (miglioriTerze.slice(0, 2).some(mt => mt.squadra === row.squadra)) {
          tr.classList.add("best-third");
        }
      });

      container.appendChild(table);
    });
  }

  function renderMiglioriTerze() {
    const container = document.getElementById("terzeClassificateContainer");
    container.innerHTML = "<h2>Classifica delle Terze Classificate</h2>";
    const table = document.createElement("table");
    table.innerHTML = "<tr><th>Squadra</th><th>Girone</th><th>Pt</th><th>DR</th><th>GF</th></tr>";

    miglioriTerze.forEach((s, idx) => {
      const tr = table.insertRow();
      tr.insertCell().textContent = s.squadra;
      tr.insertCell().textContent = s.girone;
      tr.insertCell().textContent = s.punti;
      tr.insertCell().textContent = s.diff;
      tr.insertCell().textContent = s.gf;
      if (idx < 2) tr.classList.add("highlight");
    });

    container.appendChild(table);
  }

  function renderFaseFinale(partiteFinali) {
    const container = document.getElementById("faseFinaleContainer");
    container.innerHTML = "<h2>Fase Finale</h2>";
    const table = document.createElement("table");
    table.innerHTML = "<tr><th>Turno</th><th>Data</th><th>Ora</th><th>Campo</th><th>Squadra 1</th><th>Squadra 2</th><th>Risultato</th></tr>";

    const qualificati = {};
    Object.entries(classifiche).forEach(([girone, squadre]) => {
      const sorted = Object.entries(squadre).map(([squadra, stat]) => ({
        squadra,
        punti: stat.punti,
        dr: stat.gf - stat.gs,
        gf: stat.gf
      })).sort((a, b) =>
        b.punti - a.punti || b.dr - a.dr || b.gf - a.gf
      );
      if (sorted[0]) qualificati[`1${girone}`] = sorted[0].squadra;
      if (sorted[1]) qualificati[`2${girone}`] = sorted[1].squadra;
    });

    miglioriTerze.forEach((s, i) => {
      if (i < 2) qualificati[`${i + 1}3`] = s.squadra;
    });

    partiteFinali.sort((a, b) => new Date(`${a.DATA} ${a.ORA}`) - new Date(`${b.DATA} ${b.ORA}`))
      .forEach(p => {
        const tr = table.insertRow();
        tr.insertCell().textContent = p.TURNO;
        tr.insertCell().textContent = p.DATA;
        tr.insertCell().textContent = p.ORA;
        tr.insertCell().textContent = p.CAMPO;

        const s1 = qualificati[p.SQUADRA1?.trim()] || p.SQUADRA1;
        const s2 = qualificati[p.SQUADRA2?.trim()] || p.SQUADRA2;
        tr.insertCell().textContent = s1;
        tr.insertCell().textContent = s2;
        tr.insertCell().textContent = p.RISULTATO;
      });

    container.appendChild(table);
  }

  function setupFiltri() {
    const campoFilter = document.getElementById("campoFilter");
    const giornoFilter = document.getElementById("giornoFilter");
    const gironeFilter = document.getElementById("gironeFilter");

    const campi = [...new Set(partite.map(p => p.CAMPO).filter(Boolean))].sort();
    campi.forEach(c => campoFilter.add(new Option(c, c)));

    const giorni = [...new Set(partite.map(p => p.GIORNO).filter(Boolean))].sort();
    giorni.forEach(g => giornoFilter.add(new Option(g, g)));

    [...gironi].sort().forEach(g => gironeFilter.add(new Option(g, g)));

    [campoFilter, giornoFilter, gironeFilter].forEach(select =>
      select.addEventListener("change", () => {
        renderProgramma();
        renderClassifiche();
        renderMiglioriTerze();
      })
    );
  }

  init();
</script>
</body>
</html>
