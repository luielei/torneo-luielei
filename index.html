<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>LUI&LEI - Torneo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1rem;
      background-color: #f8f9fa;
      color: #333;
    }
    h2 {
      margin-top: 2rem;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 2rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      text-align: center;
    }
    th {
      background-color: #007bff;
      color: white;
    }
    tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    .qualificata {
      background-color: #c3e6cb;
      font-weight: bold;
    }
    .migliore-terza {
      background-color: #fff3cd;
    }
    .filters {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    select {
      padding: 4px 8px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Programma Torneo LUI&LEI</h1>

  <div class="filters">
    <label>Filtro Campo:
      <select id="campoFilter">
        <option value="">Tutti</option>
      </select>
    </label>
    <label>Filtro Girone:
      <select id="gironeFilter">
        <option value="">Tutti</option>
      </select>
    </label>
    <label>Filtro Giorno:
      <select id="giornoFilter">
        <option value="">Tutti</option>
      </select>
    </label>
  </div>

  <div id="programma"></div>
  <div id="classifiche"></div>
  <div id="miglioriTerze"></div>

  <script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=1898554956&single=true&output=csv";

    async function loadCSV(url) {
      const response = await fetch(url + '&cachebuster=' + new Date().getTime());
      const text = await response.text();
      const rows = text.trim().split('\n').map(row => row.split(','));
      const headers = rows[0];
      return rows.slice(1).map(row => {
        const obj = {};
        row.forEach((val, i) => obj[headers[i]] = val);
        return obj;
      });
    }

    function getUniqueValues(data, key) {
      return [...new Set(data.map(item => item[key]))].sort();
    }

    function createSelectOptions(select, values) {
      values.forEach(val => {
        const option = document.createElement('option');
        option.value = val;
        option.textContent = val;
        select.appendChild(option);
      });
    }

    function renderProgramma(data, filters) {
      const container = document.getElementById("programma");
      container.innerHTML = "<h2>Programma Partite</h2>";
      const table = document.createElement("table");
      const thead = document.createElement("thead");
      thead.innerHTML = "<tr><th>Giorno</th><th>Data</th><th>Ora</th><th>Campo</th><th>Girone</th><th>Squadra 1</th><th>Risultato</th><th>Squadra 2</th></tr>";
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      const filtered = data.filter(d =>
        (!filters.campo || d.CAMPO === filters.campo) &&
        (!filters.girone || d.GIRONE === filters.girone) &&
        (!filters.giorno || d.GIORNO === filters.giorno)
      );

      filtered.sort((a, b) => {
        const dateA = new Date(`${a.DATA} ${a.ORA}`);
        const dateB = new Date(`${b.DATA} ${b.ORA}`);
        return dateA - dateB;
      });

      filtered.forEach(d => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${d.GIORNO}</td><td>${d.DATA}</td><td>${d.ORA}</td><td>${d.CAMPO}</td><td>${d.GIRONE}</td><td>${d.SQUADRA1}</td><td>${d.RISULTATO}</td><td>${d.SQUADRA2}</td>`;
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      container.appendChild(table);
    }

    function renderClassifiche(data, filters) {
      const container = document.getElementById("classifiche");
      container.innerHTML = "<h2>Classifiche</h2>";
      const gironi = getUniqueValues(data, "GIRONE");

      const classifiche = {};

      data.forEach(d => {
        if (!d.RISULTATO.includes("-")) return;
        const [g1, g2] = d.RISULTATO.split("-").map(Number);
        if (isNaN(g1) || isNaN(g2)) return;

        const girone = d.GIRONE;
        classifiche[girone] = classifiche[girone] || {};
        const squadre = classifiche[girone];

        [d.SQUADRA1, d.SQUADRA2].forEach(sq => {
          if (!squadre[sq]) {
            squadre[sq] = { PG: 0, V: 0, N: 0, P: 0, GF: 0, GS: 0, PUNTI: 0 };
          }
        });

        squadre[d.SQUADRA1].PG++;
        squadre[d.SQUADRA2].PG++;
        squadre[d.SQUADRA1].GF += g1;
        squadre[d.SQUADRA1].GS += g2;
        squadre[d.SQUADRA2].GF += g2;
        squadre[d.SQUADRA2].GS += g1;

        if (g1 > g2) {
          squadre[d.SQUADRA1].V++;
          squadre[d.SQUADRA2].P++;
          squadre[d.SQUADRA1].PUNTI += 3;
        } else if (g2 > g1) {
          squadre[d.SQUADRA2].V++;
          squadre[d.SQUADRA1].P++;
          squadre[d.SQUADRA2].PUNTI += 3;
        } else {
          squadre[d.SQUADRA1].N++;
          squadre[d.SQUADRA2].N++;
          squadre[d.SQUADRA1].PUNTI += 1;
          squadre[d.SQUADRA2].PUNTI += 1;
        }
      });

      const terze = [];

      Object.entries(classifiche).sort().forEach(([girone, squadre]) => {
        if (filters.girone && filters.girone !== girone) return;

        const table = document.createElement("table");
        table.innerHTML = `<thead><tr><th colspan="8">Girone ${girone}</th></tr>
          <tr><th>Squadra</th><th>PG</th><th>V</th><th>N</th><th>P</th><th>GF</th><th>GS</th><th>PUNTI</th></tr></thead>`;
        const tbody = document.createElement("tbody");

        const rows = Object.entries(squadre).map(([s, stats]) => ({ squadra: s, ...stats }));
        rows.sort((a, b) =>
          b.PUNTI - a.PUNTI ||
          (b.GF - b.GS) - (a.GF - a.GS) ||
          b.GF - a.GF
        );

        rows.forEach((row, i) => {
          const tr = document.createElement("tr");
          if (i === 0 || i === 1) tr.classList.add("qualificata");
          if (i === 2) {
            row._girone = girone;
            terze.push(row);
          }
          tr.innerHTML = `<td>${row.squadra}</td><td>${row.PG}</td><td>${row.V}</td><td>${row.N}</td><td>${row.P}</td><td>${row.GF}</td><td>${row.GS}</td><td>${row.PUNTI}</td>`;
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        container.appendChild(table);
      });

      if (!filters.girone) {
        terze.sort((a, b) =>
          b.PUNTI - a.PUNTI ||
          (b.GF - b.GS) - (a.GF - a.GS) ||
          b.GF - a.GF
        );

        const migliori = terze.slice(0, 2).map(t => t.squadra);

        const table = document.createElement("table");
        table.innerHTML = `<thead><tr><th colspan="8">Classifica Migliori Terze</th></tr>
          <tr><th>Squadra</th><th>Girone</th><th>PG</th><th>V</th><th>N</th><th>P</th><th>GF</th><th>GS</th><th>PUNTI</th></tr></thead>`;
        const tbody = document.createElement("tbody");

        terze.forEach((row, i) => {
          const tr = document.createElement("tr");
          if (migliori.includes(row.squadra)) tr.classList.add("qualificata");
          tr.innerHTML = `<td>${row.squadra}</td><td>${row._girone}</td><td>${row.PG}</td><td>${row.V}</td><td>${row.N}</td><td>${row.P}</td><td>${row.GF}</td><td>${row.GS}</td><td>${row.PUNTI}</td>`;
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        document.getElementById("miglioriTerze").innerHTML = "";
        document.getElementById("miglioriTerze").appendChild(table);
      } else {
        document.getElementById("miglioriTerze").innerHTML = "";
      }
    }

    async function init() {
      const data = await loadCSV(SHEET_URL);

      const campoFilter = document.getElementById("campoFilter");
      const gironeFilter = document.getElementById("gironeFilter");
      const giornoFilter = document.getElementById("giornoFilter");

      createSelectOptions(campoFilter, getUniqueValues(data, "CAMPO"));
      createSelectOptions(gironeFilter, getUniqueValues(data, "GIRONE"));
      createSelectOptions(giornoFilter, getUniqueValues(data, "GIORNO"));

      function renderAll() {
        const filters = {
          campo: campoFilter.value,
          girone: gironeFilter.value,
          giorno: giornoFilter.value
        };
        renderProgramma(data, filters);
        renderClassifiche(data, filters);
      }

      campoFilter.addEventListener("change", renderAll);
      gironeFilter.addEventListener("change", renderAll);
      giornoFilter.addEventListener("change", renderAll);

      renderAll();
    }

    init();
  </script>
</body>
</html>
