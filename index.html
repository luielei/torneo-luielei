<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mini-Torneo LUI&LEI</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding: 20px;
    }
    h2 {
      color: #333;
      margin-top: 40px;
    }
    .filters {
      margin-bottom: 20px;
    }
    .filters label {
      margin-right: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      background-color: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #4CAF50;
      color: white;
    }
    .highlight {
      background-color: #c8e6c9 !important;
    }
    .best-terza {
      background-color: #fff9c4 !important;
    }
  </style>
</head>
<body>
  <h1>Mini-Torneo LUI&LEI</h1>

  <div class="filters">
    <label for="campoFilter">Campo:</label>
    <select id="campoFilter"></select>

    <label for="giornoFilter">Giorno:</label>
    <select id="giornoFilter"></select>

    <label for="gironeFilter">Girone:</label>
    <select id="gironeFilter"></select>
  </div>

  <h2>Partite Fase a Gironi</h2>
  <table id="partiteTable"></table>

  <h2>Classifiche</h2>
  <div id="classificheContainer"></div>

  <h2>Fase Finale</h2>
  <table id="finaliTable"></table>

<script>
const programmaCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=1898554956&single=true&output=csv';
const finaliCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=660358441&single=true&output=csv';

async function loadCSV(url) {
  const cacheBuster = `&t=${Date.now()}`;
  const res = await fetch(url + cacheBuster);
  const text = await res.text();
  const [headerLine, ...lines] = text.trim().split('\n');
  const headers = headerLine.split(',');
  return lines.map(line => {
    const values = line.split(',');
    const obj = {};
    headers.forEach((h, i) => obj[h.trim()] = values[i]?.trim());
    return obj;
  });
}

    async function loadCSV(url) {
      const res = await fetch(url);
      const text = await res.text();
      const [headerLine, ...lines] = text.trim().split('\n');
      const headers = headerLine.split(',');
      return lines.map(line => {
        const values = line.split(',');
        const obj = {};
        headers.forEach((h, i) => obj[h.trim()] = values[i]?.trim());
        return obj;
      });
    }

    function aggiornaFiltri() {
      const giorni = [...new Set(partite.map(p => p.GIORNO))].sort();
      const campi = [...new Set(partite.map(p => p.CAMPO))].sort();
      const gironi = [...new Set(partite.map(p => p.GIRONE))].sort();

      const giornoSel = document.getElementById("filter-giorno");
      const campoSel = document.getElementById("filter-campo");
      const gironeSel = document.getElementById("filter-girone");

      [giornoSel, campoSel, gironeSel].forEach(sel => sel.innerHTML = '<option value="">Tutti</option>');

      giorni.forEach(g => giornoSel.innerHTML += `<option value="${g}">${g}</option>`);
      campi.forEach(c => campoSel.innerHTML += `<option value="${c}">${c}</option>`);
      gironi.forEach(g => gironeSel.innerHTML += `<option value="${g}">${g}</option>`);
    }

    function filtraPartite() {
      return partite.filter(p =>
        (!filters.giorno || p.GIORNO === filters.giorno) &&
        (!filters.campo || p.CAMPO === filters.campo) &&
        (!filters.girone || p.GIRONE === filters.girone)
      ).sort((a, b) => {
        return new Date(`${a.DATA} ${a.ORA}`) - new Date(`${b.DATA} ${b.ORA}`);
      });
    }

    function renderProgramma() {
      const rows = filtraPartite().map(p => `
        <tr>
          <td>${p.GIORNO}</td>
          <td>${p.ORA}</td>
          <td>${p.CAMPO}</td>
          <td>${p.GIRONE}</td>
          <td>${p.SQUADRA1}</td>
          <td>${p.SQUADRA2}</td>
          <td>${p.RISULTATO}</td>
        </tr>
      `);
      document.getElementById("programma-table").innerHTML = `
        <tr><th>Giorno</th><th>Ora</th><th>Campo</th><th>Girone</th><th>Squadra 1</th><th>Squadra 2</th><th>Risultato</th></tr>
        ${rows.join('')}
      `;
    }

    function calcolaClassifiche() {
      const gironi = {};
      partite.forEach(p => {
        if (!p.RISULTATO.includes("-")) return;

        const [gol1, gol2] = p.RISULTATO.split("-").map(Number);
        const squadre = [p.SQUADRA1, p.SQUADRA2];

        if (!gironi[p.GIRONE]) gironi[p.GIRONE] = {};
        squadre.forEach(s => {
          if (!gironi[p.GIRONE][s]) gironi[p.GIRONE][s] = {
            squadra: s, punti: 0, fatti: 0, subiti: 0, giocate: 0,
            vinte: 0, pari: 0, perse: 0
          };
        });

        gironi[p.GIRONE][p.SQUADRA1].fatti += gol1;
        gironi[p.GIRONE][p.SQUADRA1].subiti += gol2;
        gironi[p.GIRONE][p.SQUADRA1].giocate++;
        gironi[p.GIRONE][p.SQUADRA2].fatti += gol2;
        gironi[p.GIRONE][p.SQUADRA2].subiti += gol1;
        gironi[p.GIRONE][p.SQUADRA2].giocate++;

        if (gol1 > gol2) {
          gironi[p.GIRONE][p.SQUADRA1].punti += 3;
          gironi[p.GIRONE][p.SQUADRA1].vinte++;
          gironi[p.GIRONE][p.SQUADRA2].perse++;
        } else if (gol2 > gol1) {
          gironi[p.GIRONE][p.SQUADRA2].punti += 3;
          gironi[p.GIRONE][p.SQUADRA2].vinte++;
          gironi[p.GIRONE][p.SQUADRA1].perse++;
        } else {
          gironi[p.GIRONE][p.SQUADRA1].punti++;
          gironi[p.GIRONE][p.SQUADRA2].punti++;
          gironi[p.GIRONE][p.SQUADRA1].pari++;
          gironi[p.GIRONE][p.SQUADRA2].pari++;
        }
      });
      return gironi;
    }

    function renderClassifiche(classifiche) {
      const container = document.getElementById("classifiche-container");
      container.innerHTML = "";

      Object.keys(classifiche).sort().forEach(girone => {
        if (filters.girone && filters.girone !== girone) return;

        const squadre = Object.values(classifiche[girone]).sort((a, b) => b.punti - a.punti || (b.fatti - b.subiti) - (a.fatti - a.subiti));

        const rows = squadre.map((s, i) => {
          let classe = "";
          if (i < 2) classe = "highlight-top";
          return `<tr class="${classe}"><td>${s.squadra}</td><td>${s.giocate}</td><td>${s.vinte}</td><td>${s.pari}</td><td>${s.perse}</td><td>${s.punti}</td><td>${s.fatti}</td><td>${s.subiti}</td></tr>`;
        });

        container.innerHTML += `
          <h3>Girone ${girone}</h3>
          <table>
            <tr><th>Squadra</th><th>PG</th><th>V</th><th>P</th><th>S</th><th>Punti</th><th>GF</th><th>GS</th></tr>
            ${rows.join('')}
          </table>
        `;
      });
    }

    function renderTerze(classifiche) {
      const terze = Object.values(classifiche).map(gr => {
        const squadre = Object.values(gr).sort((a, b) => b.punti - a.punti || (b.fatti - b.subiti) - (a.fatti - a.subiti));
        return squadre[2];
      }).filter(Boolean);

      const migliori = terze.sort((a, b) => b.punti - a.punti || (b.fatti - b.subiti) - (a.fatti - a.subiti));

      const rows = migliori.map((s, i) => {
        let classe = i < 2 ? "highlight-top highlight-third" : "highlight-third";
        return `<tr class="${classe}"><td>${s.squadra}</td><td>${s.punti}</td><td>${s.fatti}</td><td>${s.subiti}</td></tr>`;
      });

      document.getElementById("terze-table").innerHTML = `
        <tr><th>Squadra</th><th>Punti</th><th>GF</th><th>GS</th></tr>
        ${rows.join("")}
      `;
    }

    function renderFinali(finali, classifiche) {
      const miglioriTerze = Object.values(classifiche).map(gr => Object.values(gr).sort((a, b) => b.punti - a.punti || (b.fatti - b.subiti) - (a.fatti - a.subiti))[2]).filter(Boolean).sort((a, b) => b.punti - a.punti)[0]?.squadra;

      const mapping = {
        "Prima classificata girone A": classifiche["A"] && Object.values(classifiche["A"]).sort((a, b) => b.punti - a.punti)[0]?.squadra,
        "Seconda classificata girone A": classifiche["A"] && Object.values(classifiche["A"]).sort((a, b) => b.punti - a.punti)[1]?.squadra,
        "Prima migliore terza classificata": miglioriTerze,
      };

      const rows = finali.map(p => {
        const s1 = mapping[p.SQUADRA1] || p.SQUADRA1;
        const s2 = mapping[p.SQUADRA2] || p.SQUADRA2;
        return `<tr><td>${p.TURNO}</td><td>${p.ORA}</td><td>${s1}</td><td>${s2}</td><td>${p.RISULTATO}</td></tr>`;
      });

      document.getElementById("finali-table").innerHTML = `
        <tr><th>Turno</th><th>Ora</th><th>Squadra 1</th><th>Squadra 2</th><th>Risultato</th></tr>
        ${rows.join("")}
      `;
    }

    async function init() {
      partite = await loadCSV(programmaCSV);
      finali = await loadCSV(finaliCSV);
      aggiornaFiltri();

      const classifiche = calcolaClassifiche();
      renderProgramma();
      renderClassifiche(classifiche);
      renderTerze(classifiche);
      renderFinali(finali, classifiche);
    }

    ["filter-giorno", "filter-campo", "filter-girone"].forEach(id => {
      document.getElementById(id).addEventListener("change", (e) => {
        filters[id.split("-")[1]] = e.target.value;
        init();
      });
    });

    init();
  </script>
</body>
</html>
