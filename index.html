<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mini-Torneo LUI&LEI 2025</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .highlight-top2 { background-color: #d4edda !important; }
    .highlight-best3 { background-color: #ffeeba !important; }
    .table thead th { position: sticky; top: 0; background: #f8f9fa; }
    .filter-section { margin-bottom: 1rem; }
    .hidden { display: none; }
  </style>
</head>
<body class="bg-light">
<div class="container py-4">
  <h1 class="text-center mb-4">Mini-Torneo di Calcio LUI & LEI 2025</h1>
  <div class="filter-section text-center">
    <label for="gironeFilter">Visualizza solo il girone:</label>
    <select id="gironeFilter" class="form-select w-auto d-inline-block">
      <option value="">Tutti</option>
    </select>
  </div>

  <h2>üóìÔ∏è Programma Partite (Fase a Gironi + Finali)</h2>
  <div id="matchSchedule" class="table-responsive mb-5"></div>

  <h2>üìä Classifiche dei Gironi</h2>
  <div id="groupStandings" class="mb-5"></div>

  <h2>ü•â Migliori Terze Classificate</h2>
  <div id="bestThirds" class="table-responsive"></div>
</div>

<script>
const gironi = ['A', 'B', 'C', 'D', 'E', 'F', 'G'];
const gironeFilter = document.getElementById("gironeFilter");

// Popola filtro gironi
function populateGironeFilter() {
  gironi.forEach(g => {
    const opt = document.createElement("option");
    opt.value = g;
    opt.textContent = `Girone ${g}`;
    gironeFilter.appendChild(opt);
  });
}

function fetchCSV(url) {
  return new Promise((resolve) => {
    Papa.parse(url, {
      download: true,
      header: true,
      complete: (results) => resolve(results.data.filter(row => Object.values(row).some(v => v)))
    });
  });
}

async function main() {
  populateGironeFilter();
  const programmaURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=1898554956&single=true&output=csv";
  const finaliURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=660358441&single=true&output=csv";

  const [programma, finali] = await Promise.all([fetchCSV(programmaURL), fetchCSV(finaliURL)]);

  renderMatches([...programma, ...finali]);
  computeAndRenderStandings(programma);
}

gironeFilter.addEventListener("change", () => main());

function renderMatches(matches) {
  matches.sort((a, b) => new Date(a.Data + ' ' + a.Ora) - new Date(b.Data + ' ' + b.Ora));
  const filterGirone = gironeFilter.value;

  let html = `<table class="table table-bordered table-sm">
    <thead><tr><th>Data</th><th>Ora</th><th>Campo</th><th>Girone</th><th>Squadra 1</th><th>Risultato</th><th>Squadra 2</th></tr></thead><tbody>`;
  matches.forEach(row => {
    if (filterGirone && row.Girone !== filterGirone) return;
    html += `<tr><td>${row.Data}</td><td>${row.Ora}</td><td>${row.Campo}</td><td>${row.Girone || ''}</td>
      <td>${row.Squadra1}</td><td>${row.Risultato || '-'}</td><td>${row.Squadra2}</td></tr>`;
  });
  html += '</tbody></table>';
  document.getElementById("matchSchedule").innerHTML = html;
}

function computeAndRenderStandings(matches) {
  const standings = {};
  matches.forEach(row => {
    const { Girone, Squadra1, Squadra2, Risultato } = row;
    if (!Girone || !Risultato || !Risultato.includes("-")) return;
    const [g1, g2] = Risultato.split("-").map(Number);

    [Squadra1, Squadra2].forEach(s => {
      standings[Girone] = standings[Girone] || {};
      standings[Girone][s] = standings[Girone][s] || { P:0, PG:0, GF:0, GS:0 };
    });

    standings[Girone][Squadra1].PG++;
    standings[Girone][Squadra2].PG++;
    standings[Girone][Squadra1].GF += g1;
    standings[Girone][Squadra1].GS += g2;
    standings[Girone][Squadra2].GF += g2;
    standings[Girone][Squadra2].GS += g1;

    if (g1 > g2) standings[Girone][Squadra1].P += 3;
    else if (g1 < g2) standings[Girone][Squadra2].P += 3;
    else { standings[Girone][Squadra1].P += 1; standings[Girone][Squadra2].P += 1; }
  });

  // Ordina gironi alfabeticamente
  const sortedGironi = Object.keys(standings).sort();
  const thirdTeams = [];

  let html = '';
  sortedGironi.forEach(g => {
    let teams = Object.entries(standings[g]).map(([name, stats]) => ({
      name,
      ...stats,
      DR: stats.GF - stats.GS
    }));

    teams.sort((a,b) => b.P - a.P || b.DR - a.DR || b.GF - a.GF);
    teams.forEach((t, i) => t.pos = i+1);
    thirdTeams.push(teams[2]);

    const filterGirone = gironeFilter.value;
    if (filterGirone && filterGirone !== g) return;

    html += `<h4 class="mt-4">Girone ${g}</h4>
      <div class="table-responsive">
      <table class="table table-bordered table-sm">
      <thead><tr><th>Pos</th><th>Squadra</th><th>Pt</th><th>PG</th><th>GF</th><th>GS</th><th>DR</th></tr></thead><tbody>`;

    teams.forEach(team => {
      let cls = team.pos <= 2 ? "highlight-top2" : "";
      html += `<tr class="${cls}" data-girone="${g}"><td>${team.pos}</td><td>${team.name}</td><td>${team.P}</td><td>${team.PG}</td><td>${team.GF}</td><td>${team.GS}</td><td>${team.DR}</td></tr>`;
    });
    html += '</tbody></table></div>';
  });

  // Best thirds
  const best3 = thirdTeams.filter(Boolean).sort((a,b) => b.P - a.P || b.DR - a.DR || b.GF - a.GF);
  const html3 = [`<table class="table table-bordered table-sm"><thead>
    <tr><th>Girone</th><th>Squadra</th><th>Pt</th><th>PG</th><th>GF</th><th>GS</th><th>DR</th></tr></thead><tbody>`];

  best3.forEach((t,i) => {
    const cls = i < 2 ? 'highlight-best3' : '';
    html3.push(`<tr class="${cls}"><td>${t.girone || ''}</td><td>${t.name}</td><td>${t.P}</td><td>${t.PG}</td><td>${t.GF}</td><td>${t.GS}</td><td>${t.DR}</td></tr>`);
  });
  html3.push('</tbody></table>');
  document.getElementById("groupStandings").innerHTML = html;
  document.getElementById("bestThirds").innerHTML = html3.join('');
}

main();
</script>
</body>
</html>
