<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Programma Torneo LUI&LEI</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f9f9f9; }
    select { margin: 5px; }
    table { border-collapse: collapse; width: 100%; margin: 20px 0; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #eee; }
  </style>
</head>
<body>
  <h1>Programma Torneo LUI&LEI</h1>

  <div>
    <label>Campo: <select id="filtroCampo"><option value="">Tutti</option></select></label>
    <label>Giorno: <select id="filtroGiorno"><option value="">Tutti</option></select></label>
    <label>Girone: <select id="filtroGirone"><option value="">Tutti</option></select></label>
  </div>

  <h2>Programma Partite</h2>
  <table id="programma">
    <thead>
      <tr>
        <th>Giorno</th><th>Ora</th><th>Campo</th><th>Girone</th><th>Squadra A</th><th>Risultato</th><th>Squadra B</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Classifiche per Girone</h2>
  <div id="classifiche"></div>

  <script>
    const URL_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSk6sFq6_ScnG6L8i3PNCO6CMfvxPZYvawGrvWqKq3riFp-2qxuDFozQOH1aUjsbeRglRjyFMbKAeGp/pub?gid=1898554956&single=true&output=csv";
    let datiPartite = [];

    Papa.parse(URL_CSV, {
      download: true,
      header: true,
      complete: function(results) {
        datiPartite = results.data.filter(p => p['SQUADRA A']); // rimuove righe vuote
        popolaFiltri();
        mostraProgramma();
        mostraClassifiche();
      }
    });

    function popolaFiltri() {
      const campoSet = new Set(), giornoSet = new Set(), gironeSet = new Set();
      datiPartite.forEach(p => {
        campoSet.add(p.CAMPO);
        giornoSet.add(p.GIORNO);
        gironeSet.add(p.GIRONE);
      });

      campoSet.forEach(c => addOption("filtroCampo", c));
      giornoSet.forEach(g => addOption("filtroGiorno", g));
      gironeSet.forEach(g => addOption("filtroGirone", g));

      document.getElementById("filtroCampo").onchange = mostraProgramma;
      document.getElementById("filtroGiorno").onchange = mostraProgramma;
      document.getElementById("filtroGirone").onchange = mostraProgramma;
    }

    function addOption(id, val) {
      const opt = document.createElement("option");
      opt.value = opt.text = val;
      document.getElementById(id).appendChild(opt);
    }

    function mostraProgramma() {
      const campo = document.getElementById("filtroCampo").value;
      const giorno = document.getElementById("filtroGiorno").value;
      const girone = document.getElementById("filtroGirone").value;

      const partiteFiltrate = datiPartite.filter(p =>
        (!campo || p.CAMPO === campo) &&
        (!giorno || p.GIORNO === giorno) &&
        (!girone || p.GIRONE === girone)
      );

      partiteFiltrate.sort((a, b) => {
        const d1 = new Date(`${a.GIORNO} ${a.ORA}`);
        const d2 = new Date(`${b.GIORNO} ${b.ORA}`);
        return d1 - d2;
      });

      const tbody = document.querySelector("#programma tbody");
      tbody.innerHTML = "";
      partiteFiltrate.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${p.GIORNO}</td><td>${p.ORA}</td><td>${p.CAMPO}</td><td>${p.GIRONE}</td>
                        <td>${p["SQUADRA A"]}</td><td>${p.RISULTATO}</td><td>${p["SQUADRA B"]}</td>`;
        tbody.appendChild(tr);
      });
    }

    function mostraClassifiche() {
      const gironi = [...new Set(datiPartite.map(p => p.GIRONE))];
      const container = document.getElementById("classifiche");
      container.innerHTML = "";

      gironi.forEach(girone => {
        const squadre = {};
        datiPartite.filter(p => p.GIRONE === girone && p.RISULTATO.includes("-")).forEach(p => {
          const [g1, g2] = p.RISULTATO.split("-").map(n => parseInt(n.trim()));
          const sa = p["SQUADRA A"];
          const sb = p["SQUADRA B"];
          if (!squadre[sa]) squadre[sa] = { squadra: sa, punti: 0, giocate: 0, gf: 0, gs: 0 };
          if (!squadre[sb]) squadre[sb] = { squadra: sb, punti: 0, giocate: 0, gf: 0, gs: 0 };

          squadre[sa].gf += g1; squadre[sa].gs += g2; squadre[sa].giocate++;
          squadre[sb].gf += g2; squadre[sb].gs += g1; squadre[sb].giocate++;

          if (g1 > g2) squadre[sa].punti += 3;
          else if (g2 > g1) squadre[sb].punti += 3;
          else { squadre[sa].punti += 1; squadre[sb].punti += 1; }
        });

        const classifica = Object.values(squadre);
        classifica.sort((a, b) =>
          b.punti - a.punti || (b.gf - b.gs) - (a.gf - a.gs) || b.gf - a.gf
        );

        const div = document.createElement("div");
        div.innerHTML = `<h3>Girone ${girone}</h3>
          <table>
            <thead><tr><th>Squadra</th><th>Pt</th><th>G</th><th>GF</th><th>GS</th><th>Diff</th></tr></thead>
            <tbody>
              ${classifica.map(s => `<tr>
                <td>${s.squadra}</td><td>${s.punti}</td><td>${s.giocate}</td>
                <td>${s.gf}</td><td>${s.gs}</td><td>${s.gf - s.gs}</td>
              </tr>`).join("")}
            </tbody>
          </table>`;
        container.appendChild(div);
      });
    }
  </script>
</body>
</html>
